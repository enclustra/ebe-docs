
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Enclustra Build Environment - User Documentation</title>
    <link rel="stylesheet" href="_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index_xilinx.html#document-index_xilinx">Enclustra Build Environment - User Documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="project">
<h1>Enclustra Build Environment - User Documentation<a class="headerlink" href="#project" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<span id="document-introduction"></span><div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This is the user documentation for the Enclustra Build Environment project.</p>
<div class="section" id="version-information">
<h3>Version Information<a class="headerlink" href="#version-information" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Rev</th>
<th class="head">Author</th>
<th class="head">Changes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2015-05-08</td>
<td>0.1.0</td>
<td>Karol Gugala</td>
<td>Buildsystem description</td>
</tr>
<tr class="row-odd"><td>2015-05-11</td>
<td>0.1.1</td>
<td>Aleksandra Szawara</td>
<td>Language check</td>
</tr>
<tr class="row-even"><td>2015-07-06</td>
<td>0.1.2</td>
<td>Aurelio Lucchesi</td>
<td>Minor corrections</td>
</tr>
<tr class="row-odd"><td>2015-11-20</td>
<td>0.1.3</td>
<td>Tomasz Gorochowik</td>
<td>Major reorganization</td>
</tr>
<tr class="row-even"><td>2016-06-21</td>
<td>0.1.4</td>
<td>Tomasz Gorochowik</td>
<td>Project mode section</td>
</tr>
<tr class="row-odd"><td>2017-06-23</td>
<td>0.1.5</td>
<td>Maciej Mikunda</td>
<td>Updates for release v1.5</td>
</tr>
<tr class="row-even"><td>2018-03-21</td>
<td>0.1.6</td>
<td>Mariusz Glebocki</td>
<td>Updates for release v1.6</td>
</tr>
</tbody>
</table>
</div>
</div>
<span id="document-system"></span><div class="section" id="build-environment">
<h2>Build Environment<a class="headerlink" href="#build-environment" title="Permalink to this headline">¶</a></h2>
<p>This chapter describes the usage of the build environment.
The whole build environment is written in <code class="docutils literal"><span class="pre">Python</span></code>.
Its internal functionality is determined by <cite>ini</cite> files placed in a specific directory layout.</p>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>To run the build script a Python interpreter is required.
The system is compatible with both, Python 2 and Python 3.</p>
<p>The build environment requires additional software to be installed as listed below:</p>
<table border="1" class="docutils" id="sample-table">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Required software</span><a class="headerlink" href="#sample-table" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">tool</th>
<th class="head">minimal version</th>
<th class="head">comments</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">dialog</th>
<td>1.2-20130928</td>
<td>Required only in the GUI mode</td>
</tr>
<tr class="row-odd"><th class="stub">make</th>
<td>3.81.8</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">git</th>
<td>1.9.1</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">mercurial</th>
<td>2.8.2</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">tar</th>
<td>1.27.1</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">unzip</th>
<td>6.0</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">curl</th>
<td>7.35.0</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">wget</th>
<td>1.15</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">bc</th>
<td>1.06.95</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">libssl-dev</th>
<td>1.0.0</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">patch</th>
<td>2.7.1</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">rsync</th>
<td>3.1.0</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">autoconf</th>
<td>2.69</td>
<td>Required to build a buildroot rootfs</td>
</tr>
<tr class="row-odd"><th class="stub">g++</th>
<td>4.8.3</td>
<td>Required to build a buildroot rootfs</td>
</tr>
<tr class="row-even"><th class="stub">gcc</th>
<td>4.8.3</td>
<td>Required to build the Linux kernel, U-Boot and a buildroot rootfs</td>
</tr>
</tbody>
</table>
<p>For more information on how to install the required packages in the supported systems, please refer to the corresponding subsection (<a class="reference internal" href="#suse"><span class="std std-ref">OpenSUSE 42.3</span></a>, <a class="reference internal" href="#ubuntu"><span class="std std-ref">Ubuntu 14.04 LTS</span></a>).</p>
<div class="section" id="opensuse-42-3">
<span id="suse"></span><h4>OpenSUSE 42.3<a class="headerlink" href="#opensuse-42-3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span></span>su -
zypper -n install -yt pattern devel_basis
zypper -n install -y autoconf bc curl gcc-c++ git glibc-32bit <span class="se">\</span>
                     mercurial python-dialog unzip wget
</pre></div>
</div>
</div>
<div class="section" id="ubuntu-14-04-lts">
<span id="ubuntu"></span><h4>Ubuntu 14.04 LTS<a class="headerlink" href="#ubuntu-14-04-lts" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt update
sudo apt install -y autoconf bc build-essential curl git mercurial <span class="se">\</span>
                    libc6-i386 python python-dialog unzip wget
</pre></div>
</div>
</div>
</div>
<div class="section" id="directory-structure">
<h3>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h3>
<p>The build environment is designed to work with a specific directory structure depicted below:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="p">|</span>-- bin
<span class="p">|</span>-- binaries
<span class="p">|</span>-- buildscripts
<span class="p">|</span>-- sources
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_1
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_2
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_3
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_4
<span class="p">|</span>-- targets
<span class="p">|</span>   <span class="p">|</span>-- Module_1
<span class="p">|</span>       <span class="p">|</span>-- BaseBoard_1
<span class="p">|</span>       <span class="p">|</span>-- BaseBoard_2
<span class="p">|</span>   <span class="p">|</span>-- Module_2
<span class="p">|</span>       <span class="p">|</span>-- BaseBoard_1
<span class="p">|</span>-- target_output
</pre></div>
</div>
<table border="1" class="docutils" id="folder-description">
<caption><span class="caption-number">Table 2 </span><span class="caption-text">Folder description</span><a class="headerlink" href="#folder-description" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Folder</th>
<th class="head">function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">bin</th>
<td>Remote toolchains installation folder.</td>
</tr>
<tr class="row-odd"><th class="stub">binaries</th>
<td>Additional target binaries download folder.</td>
</tr>
<tr class="row-even"><th class="stub">sources</th>
<td>master_git_repository clone folder. It contains submodule folders.</td>
</tr>
<tr class="row-odd"><th class="stub">buildscripts</th>
<td>Build system executable files.</td>
</tr>
<tr class="row-even"><th class="stub">targets</th>
<td>Target configurations are placed here.</td>
</tr>
<tr class="row-odd"><th class="stub">target_output</th>
<td>Folders generated during the build process, that contain the output files after a successful build of every specifc target.</td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>By default, the target output folders are named according to this folder naming scheme:</p>
<p><code class="docutils literal"><span class="pre">out_&lt;timestamp&gt;_&lt;module&gt;_&lt;board&gt;_&lt;bootmode&gt;</span></code>.</p>
<p class="last">The default name can be overwriten during the build process.</p>
</div>
</div>
<div class="section" id="repositories-structure">
<h3>Repositories Structure<a class="headerlink" href="#repositories-structure" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">sources</span></code> directory is the master git repository with a number of submodules pointing to actual code repositories.
During the fetch phase, the build environment synchronizes only the submodules required to build the selected targets.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>.
<span class="p">|</span>-- container_git_repository
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_1
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_2
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_3
</pre></div>
</div>
</div>
<div class="section" id="general-build-environment-configuration">
<h3>General Build Environment Configuration<a class="headerlink" href="#general-build-environment-configuration" title="Permalink to this headline">¶</a></h3>
<p>Environment settings are stored in the <code class="docutils literal"><span class="pre">enclustra.ini</span></code> file in the main directory of the build environment.
Before starting the build script, one may need to adjust the general settings of the build environment by editing this file.
One of the most crucial setting is the number of build threads used in a parallel.
This parameter is set in the <code class="docutils literal"><span class="pre">[general]</span></code> section by changing the <code class="docutils literal"><span class="pre">nthreads</span></code> key.
Additionally, parameters in the <code class="docutils literal"><span class="pre">[debug]</span></code> section allow the user to adjust the logging settings:</p>
<ul class="simple">
<li>If the <code class="docutils literal"><span class="pre">debug-calls</span></code> option if set to <code class="docutils literal"><span class="pre">true</span></code>, the output of all external tool calls (such as <code class="docutils literal"><span class="pre">make</span></code>, <code class="docutils literal"><span class="pre">tar</span></code> etc.) will be displayed in the terminal.</li>
<li>If the <code class="docutils literal"><span class="pre">quiet-mode</span></code> option is set to <code class="docutils literal"><span class="pre">true</span></code>, the build log of the targets will not be printed to the terminal, only informations about actual build state will be shown. This option does not affect the <code class="docutils literal"><span class="pre">build-logfile</span></code> option.</li>
<li>If the <code class="docutils literal"><span class="pre">build-logfile</span></code> option is set to a file name, the build environment will write the whole build log output to that file. If the option is not set, the output will not be logged.</li>
<li>If the <code class="docutils literal"><span class="pre">break-on-error</span></code> option is set to <code class="docutils literal"><span class="pre">true</span></code>, the build environment will interrupted on the first error. Otherwise the build environment will only print an error message and continue to work on a next available target.</li>
</ul>
</div>
</div>
<span id="document-supported_devices_xilinx"></span><div class="section" id="supported-devices">
<h2>Supported Devices<a class="headerlink" href="#supported-devices" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils" id="supported-devices-xilinx">
<caption><span class="caption-number">Table 3 </span><span class="caption-text">Supported devices</span><a class="headerlink" href="#supported-devices-xilinx" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Family</th>
<th class="head">Module</th>
<th class="head">Base board</th>
<th class="head">Available targets</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Xilinx</th>
<td>Cosmos XZQ10</td>
<td>–</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Xilinx</th>
<td>Mars ZX2</td>
<td>Mars Starter</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Xilinx</th>
<td>Mars ZX2</td>
<td>Mars EB1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Xilinx</th>
<td>Mars ZX2</td>
<td>Mars PM3</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Xilinx</th>
<td>Mars ZX3</td>
<td>Mars Starter</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Xilinx</th>
<td>Mars ZX3</td>
<td>Mars EB1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Xilinx</th>
<td>Mars ZX3</td>
<td>Mars PM3</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Xilinx</th>
<td>Mars XU3</td>
<td>Mars EB1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Xilinx</th>
<td>Mercury ZX1</td>
<td>Mercury PE1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Xilinx</th>
<td>Mercury ZX5</td>
<td>Mercury PE1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Xilinx</th>
<td>Mercury+ XU1</td>
<td>Mercury PE1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since release 1.7, the ZU3EG ES variant of the Mars XU3 module is no longer supported.</p>
</div>
</div>
<span id="document-quickstart_xilinx"></span><div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="gui">
<h3>GUI<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>By default the build script will fetch and build the latest EBE release.
To use a specific release you need to clone a clean copy of the EBE repo and switch to a selected release:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">enclustra</span><span class="o">-</span><span class="n">bsp</span><span class="o">/</span><span class="n">bsp</span><span class="o">-</span><span class="n">xilinx</span><span class="o">.</span><span class="n">git</span> <span class="o">-</span><span class="n">b</span> <span class="n">v1</span><span class="o">.</span><span class="n">x</span>
<span class="c1"># where v1.x is the release number (e.g. v1.5)</span>
</pre></div>
</div>
<p>In order to use the latest code, switch to develop release:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">enclustra</span><span class="o">-</span><span class="n">bsp</span><span class="o">/</span><span class="n">bsp</span><span class="o">-</span><span class="n">xilinx</span><span class="o">.</span><span class="n">git</span> <span class="o">-</span><span class="n">b</span> <span class="n">develop</span>
<span class="n">export</span> <span class="n">EBE_RELEASE</span><span class="o">=</span><span class="n">master</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since software in the develop release uses code which is currently under development the resulting software may be unstable.</p>
</div>
<p>In order to build the software for a chosen board using the GUI, please follow these steps:</p>
<ol class="arabic">
<li><p class="first">Clone the build environment repository with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">enclustra</span><span class="o">-</span><span class="n">bsp</span><span class="o">/</span><span class="n">bsp</span><span class="o">-</span><span class="n">xilinx</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
</li>
<li><p class="first">Change to the <code class="docutils literal"><span class="pre">bsp-xilinx</span></code> directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">bsp</span><span class="o">-</span><span class="n">xilinx</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the <code class="docutils literal"><span class="pre">./build.sh</span></code> script.</p>
</li>
<li><p class="first">The welcome screen provides basic information about the version of the build environment.</p>
<img alt="_images/welcome_screen.png" src="_images/welcome_screen.png" />
</li>
<li><p class="first">Choose the configuration.</p>
<img alt="_images/choose_config_xilinx.png" src="_images/choose_config_xilinx.png" />
</li>
<li><p class="first">Choose the chip type.</p>
<img alt="_images/chip_xilinx.png" src="_images/chip_xilinx.png" />
</li>
<li><p class="first">Choose the module type.</p>
<img alt="_images/module_xilinx.png" src="_images/module_xilinx.png" />
</li>
<li><p class="first">Choose the base board type.</p>
<img alt="_images/board_xilinx.png" src="_images/board_xilinx.png" />
</li>
<li><p class="first">Choose the boot device.</p>
<img alt="_images/bootmode.png" src="_images/bootmode.png" />
</li>
<li><p class="first">Choose which targets available for the chosen device family will be fetched. On the bottom of the screen a short description of the highlighted target is displayed. Choosing certain targets may disable fetching others.</p>
<img alt="_images/fetch.png" src="_images/fetch.png" />
</li>
<li><p class="first">Choose which targets will be built. On the bottom of the screen a short description of a highlighted target is displayed. Choosing certain targets may disable building others. In order to use the default target configuration enable the <code class="docutils literal"><span class="pre">Load</span> <span class="pre">initial</span> <span class="pre">...</span> <span class="pre">configuration</span></code> checkbox. If changes have been made to the target, disable this checkbox, so that the changes are not overwritten during the build process.</p>
<img alt="_images/build.png" src="_images/build.png" />
</li>
<li><p class="first">Choose the exact version of the device (chip type, industrial/commercial grade, speed grade).</p>
<img alt="_images/dev_option_xilinx.png" src="_images/dev_option_xilinx.png" />
</li>
<li><p class="first">Customize binaries or use the default ones.</p>
<img alt="_images/custom_bin_xilinx.png" src="_images/custom_bin_xilinx.png" />
</li>
<li><p class="first">Verify all the chosen build parameters.</p>
<img alt="_images/summary_xilinx.png" src="_images/summary_xilinx.png" />
</li>
<li><p class="first">Choose whether or not to save the configuration for later use.</p>
<img alt="_images/save_xilinx.png" src="_images/save_xilinx.png" />
</li>
<li><p class="first">The build environment will fetch and build the chosen targets.</p>
</li>
</ol>
</div>
<div class="section" id="command-line">
<h3>Command Line<a class="headerlink" href="#command-line" title="Permalink to this headline">¶</a></h3>
<p>The build process can be invoked from the command line. All options that are available in the GUI are present on the command line interface as well.
A list of the available command line options can be obtained like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">build</span><span class="o">.</span><span class="n">sh</span> <span class="o">--</span><span class="n">help</span>

<span class="n">usage</span><span class="p">:</span> <span class="n">tool</span> <span class="p">[</span><span class="o">-</span><span class="n">h</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">release</span> <span class="n">ver</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">L</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">devices</span><span class="o">-</span><span class="n">raw</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">d</span> <span class="n">device</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">l</span><span class="p">]</span>
    <span class="p">[</span><span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">targets</span><span class="o">-</span><span class="n">raw</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">x</span> <span class="n">target</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">f</span> <span class="n">target</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">b</span> <span class="n">target</span><span class="p">]</span>
    <span class="p">[</span><span class="o">--</span><span class="n">custom</span><span class="o">-</span><span class="n">build</span> <span class="n">target</span> <span class="n">steps</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">fetch</span><span class="o">-</span><span class="n">history</span> <span class="n">target</span><span class="p">]</span>
    <span class="p">[</span><span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">binaries</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">B</span> <span class="n">file</span> <span class="n">path</span><span class="p">]</span>
    <span class="p">[</span><span class="o">--</span><span class="n">anti</span><span class="o">-</span><span class="n">unicorn</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">expert</span><span class="o">-</span><span class="n">mode</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">o</span> <span class="n">index</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">project</span><span class="p">]</span>
    <span class="p">[</span><span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">project</span> <span class="n">project_file</span><span class="p">]</span> <span class="p">[</span><span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">project</span><span class="o">-</span><span class="n">auto</span> <span class="n">project_file</span><span class="p">]</span>
    <span class="p">[</span><span class="o">-</span><span class="n">s</span> <span class="n">cfg</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">c</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">C</span><span class="p">]</span> <span class="p">[</span><span class="o">-</span><span class="n">v</span><span class="p">]</span>

<span class="n">Enclustra</span> <span class="n">Build</span> <span class="n">Environment</span>

<span class="n">optional</span> <span class="n">arguments</span><span class="p">:</span>
  <span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="o">--</span><span class="n">help</span>                    <span class="n">show</span> <span class="n">this</span> <span class="n">help</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
  <span class="o">--</span><span class="n">release</span> <span class="n">ver</span>                 <span class="n">specify</span> <span class="n">release</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">buidscripts</span>
  <span class="o">-</span><span class="n">L</span><span class="p">,</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">devices</span>            <span class="nb">list</span> <span class="nb">all</span> <span class="n">available</span> <span class="n">devices</span>
  <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">devices</span><span class="o">-</span><span class="n">raw</span>            <span class="nb">list</span> <span class="nb">all</span> <span class="n">available</span> <span class="n">devices</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">script</span>
                                <span class="n">friendly</span> <span class="n">way</span>
  <span class="o">-</span><span class="n">d</span> <span class="n">device</span><span class="p">,</span> <span class="o">--</span><span class="n">device</span> <span class="n">device</span>    <span class="n">specify</span> <span class="n">device</span> <span class="k">as</span> <span class="n">follows</span><span class="p">:</span>
                                <span class="o">&lt;</span><span class="n">family</span><span class="o">&gt;/&lt;</span><span class="n">module</span><span class="o">&gt;/&lt;</span><span class="n">base_board</span><span class="o">&gt;/&lt;</span><span class="n">boot_device</span><span class="o">&gt;</span>
  <span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">targets</span>            <span class="nb">list</span> <span class="nb">all</span> <span class="n">targets</span> <span class="k">for</span> <span class="n">chosen</span> <span class="n">device</span>
  <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">targets</span><span class="o">-</span><span class="n">raw</span>            <span class="nb">list</span> <span class="nb">all</span> <span class="n">targets</span> <span class="k">for</span> <span class="n">chosen</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">script</span>
                                <span class="n">friendly</span> <span class="n">way</span>
  <span class="o">-</span><span class="n">x</span> <span class="n">target</span>                     <span class="n">fetch</span> <span class="ow">and</span> <span class="n">build</span> <span class="n">specific</span> <span class="n">target</span>
  <span class="o">-</span><span class="n">f</span> <span class="n">target</span><span class="p">,</span> <span class="o">--</span><span class="n">fetch</span> <span class="n">target</span>     <span class="n">fetch</span> <span class="n">specific</span> <span class="n">target</span>
  <span class="o">-</span><span class="n">b</span> <span class="n">target</span><span class="p">,</span> <span class="o">--</span><span class="n">build</span> <span class="n">target</span>     <span class="n">build</span> <span class="n">specific</span> <span class="n">target</span>
  <span class="o">--</span><span class="n">custom</span><span class="o">-</span><span class="n">build</span> <span class="n">target</span> <span class="n">steps</span>   <span class="n">build</span> <span class="n">specific</span> <span class="n">target</span> <span class="k">with</span> <span class="n">specific</span> <span class="n">steps</span>
                                <span class="p">(</span><span class="n">comma</span> <span class="n">separated</span><span class="p">)</span>
  <span class="o">--</span><span class="n">fetch</span><span class="o">-</span><span class="n">history</span> <span class="n">target</span>        <span class="n">fetch</span> <span class="n">specific</span> <span class="n">target</span> <span class="k">with</span> <span class="n">history</span>
  <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">options</span>            <span class="nb">list</span> <span class="nb">all</span> <span class="n">available</span> <span class="n">device</span> <span class="n">options</span> <span class="k">for</span> <span class="n">chosen</span>
                                <span class="n">device</span>
  <span class="o">--</span><span class="nb">list</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">binaries</span>           <span class="nb">list</span> <span class="nb">all</span> <span class="n">available</span> <span class="n">binary</span> <span class="n">files</span> <span class="k">for</span> <span class="n">chosen</span>
                                <span class="n">device</span>
  <span class="o">-</span><span class="n">B</span> <span class="n">file</span> <span class="n">path</span><span class="p">,</span> <span class="o">--</span><span class="n">custom</span><span class="o">-</span><span class="n">binary</span> <span class="n">file</span> <span class="n">path</span>
                                <span class="n">exchange</span> <span class="n">selected</span> <span class="n">binary</span> <span class="n">file</span> <span class="k">with</span> <span class="n">the</span> <span class="n">one</span>
                                <span class="n">pointed</span> <span class="n">by</span> <span class="n">the</span> <span class="n">path</span>
  <span class="o">--</span><span class="n">anti</span><span class="o">-</span><span class="n">unicorn</span>                <span class="n">disables</span> <span class="n">colored</span> <span class="n">output</span>
  <span class="o">--</span><span class="n">expert</span><span class="o">-</span><span class="n">mode</span>                 <span class="n">expert</span> <span class="n">mode</span><span class="p">:</span> <span class="n">prepare</span> <span class="n">the</span> <span class="n">environment</span> <span class="k">for</span>
                                <span class="n">building</span> <span class="n">the</span> <span class="n">whole</span> <span class="n">system</span> <span class="n">manually</span>
  <span class="o">-</span><span class="n">o</span> <span class="n">index</span><span class="p">,</span> <span class="o">--</span><span class="n">dev</span><span class="o">-</span><span class="n">option</span> <span class="n">index</span>  <span class="nb">set</span> <span class="n">device</span> <span class="n">option</span> <span class="n">by</span> <span class="n">index</span><span class="p">,</span> <span class="n">the</span> <span class="n">default</span> <span class="n">one</span>
                                <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">specified</span>
  <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">project</span>            <span class="n">generate</span> <span class="n">project</span> <span class="n">directory</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">a</span>
                                <span class="n">regular</span> <span class="n">output</span>
  <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">project</span> <span class="n">project_file</span>  <span class="n">build</span> <span class="n">project</span>
  <span class="o">--</span><span class="n">build</span><span class="o">-</span><span class="n">project</span><span class="o">-</span><span class="n">auto</span> <span class="n">project_file</span>
                                <span class="n">build</span> <span class="n">project</span> <span class="n">automatically</span><span class="p">,</span> <span class="n">skip</span> <span class="n">the</span> <span class="n">gui</span>
  <span class="o">-</span><span class="n">s</span> <span class="n">cfg</span><span class="p">,</span> <span class="o">--</span><span class="n">saved</span><span class="o">-</span><span class="n">config</span> <span class="n">cfg</span>    <span class="n">use</span> <span class="n">previously</span> <span class="n">saved</span> <span class="n">configuration</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="o">--</span><span class="n">clean</span><span class="o">-</span><span class="nb">all</span>               <span class="n">delete</span> <span class="nb">all</span> <span class="n">downloaded</span> <span class="n">code</span><span class="p">,</span> <span class="n">binaries</span><span class="p">,</span> <span class="n">tools</span>
                                <span class="ow">and</span> <span class="n">built</span> <span class="n">files</span>
  <span class="o">-</span><span class="n">C</span><span class="p">,</span> <span class="o">--</span><span class="n">clean</span><span class="o">-</span><span class="n">soft</span>              <span class="n">run</span> <span class="n">clean</span> <span class="n">commands</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">specified</span> <span class="n">targets</span>
                                <span class="p">(</span><span class="k">if</span> <span class="n">available</span><span class="p">)</span>
  <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">version</span>                 <span class="nb">print</span> <span class="n">version</span>
</pre></div>
</div>
<p>In order to list all available devices use the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -L
</pre></div>
</div>
<p>If the <code class="docutils literal"><span class="pre">build.sh</span></code> script is invoked with the <code class="docutils literal"><span class="pre">-d</span></code> option, the build environment switches to console mode.
This mode requires a valid device specifier in order to locate the device configuration within the <code class="docutils literal"><span class="pre">targets</span></code> directory for the specific device, e.g. for the <cite>Mars ZX3</cite> module on the <cite>Mars PM3</cite> base board in <cite>QSPI</cite> boot mode, the command would look like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Zynq-7000/Mars_ZX3/Mars_PM3/QSPI
</pre></div>
</div>
<p>Such a command will fetch and build all the default targets for a selected device.
To list all the available targets for a selected device, the user needs to add the <code class="docutils literal"><span class="pre">-l</span></code> switch to the command, e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Zynq-7000/Mars_ZX3/Mars_PM3/QSPI -l
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">-x</span></code> option will fetch and build only the selected target, e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Zynq-7000/Mars_ZX3/Mars_PM3/QSPI -x Linux
</pre></div>
</div>
<p>That will fetch and build only the <code class="docutils literal"><span class="pre">Linux</span></code> target for the selected device.</p>
<p>To only fetch or build a specific target, the user can specify those targets with the <code class="docutils literal"><span class="pre">-f</span></code> (fetch) and <code class="docutils literal"><span class="pre">-b</span></code> (build) options. It is possible to choose multiple targets, e.g. like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Zynq-7000/Mars_ZX3/Mars_PM3/QSPI -f Linux -b Buildroot -x U-Boot
</pre></div>
</div>
<p>This will fetch Linux, build Buildroot and fetch/build U-Boot.</p>
<p>The <code class="docutils literal"><span class="pre">--list-dev-options</span></code> option will list all the available device options for the chosen device. It can be used like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Zynq-7000/Mars_ZX3/Mars_PM3/QSPI -x Linux --list-dev-options
</pre></div>
</div>
<p>This will print out an indexed list of device options.</p>
<p>The <code class="docutils literal"><span class="pre">-o</span></code> option allows the user to choose a device option for the selected device by providing the index of a specific device option, like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Zynq-7000/Mars_ZX3/Mars_PM3/QSPI -x Linux -o <span class="m">1</span>
</pre></div>
</div>
<p>If no device option is selected, the default one will be used.</p>
<p>To reset the build environment and delete all downloaded code, binaries, tools and built files, the <code class="docutils literal"><span class="pre">--clean</span></code> option can be used:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh --clean
</pre></div>
</div>
</div>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>This chapter describes how to prepare the hardware to boot from different boot media, using the binaries generated from the build environment.
The boot process differs in its details on different hardware, but in general it covers the following steps:</p>
<ol class="arabic simple">
<li>BootRom embedded in a CPU starts execution after reset. It searches through a predefined storages for a next (first) stage boot loader.</li>
<li>First stage boot loader (FSBL, U-Boot SPL) is loaded into On Chip Memory, and executed.</li>
<li>First stage boot loader initializes RAM controller, clocks and loads second stage boot loader into RAM.</li>
<li>Second stage boot loader (U-Boot) loads the Linux kernel, device tree blob and any other required files into RAM and runs the Linux kernel.</li>
<li>Linux kernel configures peripherals, mounts user space root filesystem and executes the <code class="docutils literal"><span class="pre">init</span></code> application within it.</li>
<li><code class="docutils literal"><span class="pre">Init</span></code> application starts the rest of the user space applications - the system is up and running.</li>
</ol>
<p>For more detailed information about the boot process on a Xilinx Zynq devices please refer to:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.xilinx.com/support/documentation/user_guides/ug585-Zynq-7000-TRM.pdf">Xilinx Zynq technical reference guide (chapters 6 and 32)</a>.</li>
</ul>
<p>All the guides in this section require the user to build the required files for the chosen device, with the build environment, as described in the previous section.
Once the files are built, they can be deployed to the hardware as described in the following sub sections.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Default target output directories are named according to the following directory naming scheme:</p>
<p class="last"><code class="docutils literal"><span class="pre">out_&lt;timestamp&gt;_&lt;module&gt;_&lt;board&gt;_&lt;bootmode&gt;</span></code>.</p>
</div>
<p>As a general note on U-Boot used in all the following guides: U-Boot is using variables from the default environment. Moreover, the boot scripts used by U-Boot also rely on those variables. If the environment was changed and saved earlier, U-Boot will always use these saved environment variables on a fresh boot, even after changing the U-Boot environment.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Regardless of the selected boot mode, the U-Boot environment is stored in the last 512 KiB of the QSPI flash memory.</p>
</div>
<p>To restore the default environment, run the following command in the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>env default -a
</pre></div>
</div>
<p>This will not overwrite the stored environment but will only restore the default one in the current run.
To permanently restore the default environment, the <code class="docutils literal"><span class="pre">saveenv</span></code> command has to be invoked.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A <code class="docutils literal"><span class="pre">***</span> <span class="pre">Warning</span> <span class="pre">-</span> <span class="pre">bad</span> <span class="pre">CRC,</span> <span class="pre">using</span> <span class="pre">default</span> <span class="pre">environment</span></code> warning message that appears when booting into U-Boot indicates that the default environment will be loaded.</p>
</div>
<div class="section" id="sd-card-mmc">
<span id="xilinx-mmc"></span><h3>SD Card (MMC)<a class="headerlink" href="#sd-card-mmc" title="Permalink to this headline">¶</a></h3>
<p>In order to deploy images to an SD Card and boot from it, perform the following steps as root:</p>
<ol class="arabic">
<li><p class="first">Create a FAT formatted BOOT partition as the first one on the SD Card. The size of the partition should be at least 64 MB. (For more information on how to prepare the boot medium, please refer to the official <a class="reference external" href="http://www.wiki.xilinx.com/Prepare+Boot+Medium">Xilinx guide</a>.)</p>
</li>
<li><p class="first">Create an ext4 formatted partition (rootfs) as the second one on the SD Card. The size of the partition should be at least 64 MB.</p>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">boot.bin</span></code>, the kernel image (<code class="docutils literal"><span class="pre">uImage</span></code> for Zynq-7000 or <code class="docutils literal"><span class="pre">Image</span></code> for Zynq Ultrascale+), <code class="docutils literal"><span class="pre">devicetree.dtb</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> (or <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> file when using RAMDISK, which must be renamed to <code class="docutils literal"><span class="pre">uboot.scr</span></code>) from the build environment output directory onto the BOOT partition (FAT formatted). Copy <code class="docutils literal"><span class="pre">uramdisk</span></code> to the same partition (only when using RAMDISK).</p>
</li>
<li><p class="first">Extract the <code class="docutils literal"><span class="pre">rootfs.tar</span></code> archive from the build environment output directory onto the second partition (rootfs, ext4 formatted).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step is required only for persistent rootfs.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo tar -xpf rootfs.tar -C /path/to/mmc/mountpoint
</pre></div>
</div>
</li>
<li><p class="first">Unmount all partitions mounted from the SD Card.</p>
</li>
<li><p class="first">Insert the card into the SD Card slot on the board.</p>
</li>
<li><p class="first">Configure the board to boot from the SD Card (refer to the board User Manual).</p>
</li>
<li><p class="first">Power on the board.</p>
</li>
<li><p class="first">The board should boot the Linux system.</p>
</li>
</ol>
<p>If one wants to manually trigger booting from a SD Card, the following command has to be invoked from the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run sdboot
</pre></div>
</div>
</div>
<div class="section" id="emmc-flash">
<span id="xilinx-qspi"></span><h3>eMMC Flash<a class="headerlink" href="#emmc-flash" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Prepare a bootable SD card with a ramdisk or persistent rootfs as described in <a class="reference internal" href="#xilinx-mmc"><span class="std std-ref">SD Card (MMC)</span></a>.</p>
</li>
<li><p class="first">You’ll need the following files from eMMC build:
<code class="docutils literal"><span class="pre">boot.bin</span></code>, <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">Image</span></code> (Zynq Ultrascale+ only), <code class="docutils literal"><span class="pre">uImage</span></code> (Zynq-7000 only).
Additionally, you’ll need <code class="docutils literal"><span class="pre">uramdisk</span></code>, <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> when you want to use a ramdisk, and <code class="docutils literal"><span class="pre">rootfs.tar</span></code>, <code class="docutils literal"><span class="pre">uboot.scr</span></code> to use a persistent rootfs.
Copy the files to a TFTP server’s directory to load them later through the network.
If you don’t want to use the network connection on the board, copy the files to the <code class="docutils literal"><span class="pre">emmc</span></code> directory on the SD card’s rootfs partition instead.</p>
</li>
<li><p class="first">Boot Linux on the device from the SD Card (ramdisk or persistent rootfs) and login as root.</p>
</li>
<li><p class="first">If you’ve put eMMC build files on the SD card, and you’re booting from a ramdisk, mount the SD card’s second partition in <code class="docutils literal"><span class="pre">/mnt</span></code>.
When booting from a persistent rootfs, the files are already in <code class="docutils literal"><span class="pre">/emmc</span></code>. In either case, <code class="docutils literal"><span class="pre">cd</span></code> to a directory with the files.
In the case of files located on a TFTP server, connect to the network by running <code class="docutils literal"><span class="pre">dhcpcd</span> <span class="pre">eth0</span></code> and download the files:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tftp -g -r boot.bin       <span class="nv">$SERVER_IP</span>
tftp -g -r devicetree.dtb <span class="nv">$SERVER_IP</span>
tftp -g -r uImage         <span class="nv">$SERVER_IP</span>  <span class="c1"># Zynq-7000 only</span>
tftp -g -r Image          <span class="nv">$SERVER_IP</span>  <span class="c1"># Ultrascale+ only</span>

<span class="c1"># For eMMC with persistent rootfs:</span>
tftp -g -r rootfs.tar     <span class="nv">$SERVER_IP</span>
tftp -g -r uboot.scr      <span class="nv">$SERVER_IP</span>

<span class="c1"># For eMMC with ramdisk:</span>
tftp -g -r uramdisk       <span class="nv">$SERVER_IP</span>
tftp -g -r uboot_ramdisk.scr -l uboot.scr <span class="nv">$SERVER_IP</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">$SERVER_IP</span></code> is your TFTP server IP address.</p>
</li>
<li><p class="first">There are two <code class="docutils literal"><span class="pre">/dev/mmcblkN</span></code> devices.
One of them is the SD card, and the other is the eMMC.
To identify the eMMC, look which one has the <code class="docutils literal"><span class="pre">boot0</span></code> partition:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk</span><span class="o">*</span><span class="n">boot0</span>
</pre></div>
</div>
</li>
<li><p class="first">Partition the eMMC. Create a FAT32 <code class="docutils literal"><span class="pre">boot</span></code> partition as the first partition on the device, make its size at least 64 MB.
If you want to use a persistent rootfs, create a second ext4 <code class="docutils literal"><span class="pre">rootfs</span></code> partition (at least 64 MB large).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For more information on how to prepare the boot medium, please refer to the official <a class="reference external" href="http://www.wiki.xilinx.com/Prepare+Boot+Medium">Xilinx guide</a>.
Remember to use eMMC device <code class="docutils literal"><span class="pre">mmcblkX</span></code> instead of <code class="docutils literal"><span class="pre">sdX</span></code>.</p>
</div>
</li>
<li><p class="first">Mount the <code class="docutils literal"><span class="pre">boot</span></code> partition and copy boot files to it:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblkXp1</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>

<span class="n">cp</span> <span class="n">boot</span><span class="o">.</span><span class="n">bin</span> <span class="n">devicetree</span><span class="o">.</span><span class="n">dtb</span> <span class="n">uboot</span><span class="o">.</span><span class="n">scr</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span>
<span class="n">cp</span> <span class="n">uImage</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span>  <span class="c1"># Zynq-7000 only</span>
<span class="n">cp</span> <span class="n">Image</span>  <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span>  <span class="c1"># Ultrascale+ only</span>
<span class="c1"># For eMMC with ramdisk:</span>
<span class="n">cp</span> <span class="n">uramdisk</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span><span class="o">/</span>

<span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">boot</span>
</pre></div>
</div>
</li>
<li><p class="first">Mount the <code class="docutils literal"><span class="pre">rootfs</span></code> partition and extract <code class="docutils literal"><span class="pre">rootfs.tar</span></code> (persistent rootfs only):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">rootfs</span>
<span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblkXp2</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">rootfs</span>

<span class="n">tar</span> <span class="o">-</span><span class="n">xpv</span> <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">rootfs</span><span class="o">/</span> <span class="o">-</span><span class="n">f</span> <span class="n">rootfs</span><span class="o">.</span><span class="n">tar</span>

<span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">rootfs</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="qspi-flash">
<h3>QSPI Flash<a class="headerlink" href="#qspi-flash" title="Permalink to this headline">¶</a></h3>
<p>The QSPI Flash is divided into 6 partitions based on U-Boot environment variables.
Those variables are calculated and set automatically, so in most cases there is no need to change them.
For more detailed information on partition offsets and sizes, please refer to <a class="reference internal" href="#xilinx-qspi-layout"><span class="std std-ref">QSPI Flash Layouts</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since release 1.5, 16MB QSPI Flash memories are no longer supported.</p>
</div>
<p>In order to deploy images to QSPI Flash and boot from it, do the following steps:</p>
<ol class="arabic">
<li><p class="first">Setup a TFTP server on the host computer.</p>
</li>
<li><p class="first">Power on the board and boot to U-Boot (e.g. from a SD Card (MMC)).</p>
</li>
<li><p class="first">Connect an Ethernet cable to the device.</p>
</li>
<li><p class="first">Connect a serial console to the device (e.g. using PuTTY or picocom).</p>
</li>
<li><p class="first">Setup the U-Boot connection parameters (in the U-Boot console):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>setenv ipaddr <span class="s1">&#39;xxx.xxx.xxx.xxx&#39;</span>
<span class="c1"># where xxx.xxx.xxx.xxx is the board address</span>
setenv serverip <span class="s1">&#39;yyy.yyy.yyy.yyy&#39;</span>
<span class="c1"># where yyy.yyy.yyy.yyy is the server (host computer) address</span>
</pre></div>
</div>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">boot.bin</span></code>, the kernel image (<code class="docutils literal"><span class="pre">uImage</span></code> for Zynq-7000 or <code class="docutils literal"><span class="pre">Image</span></code> for Zynq Ultrascale+), <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">uboot.scr</span></code> (or <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> file which must be renamed to <code class="docutils literal"><span class="pre">uboot.scr</span></code>) and <code class="docutils literal"><span class="pre">rootfs.jffs2</span></code> (or <code class="docutils literal"><span class="pre">uramdisk</span></code> when using RAMDISK) from the build environment output directory to the TFTP server directory.</p>
</li>
<li><p class="first">Set memory pinmux to QSPI Flash:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step is required only for modules equipped with Zynq-7000 devices.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>zx_set_storage QSPI
</pre></div>
</div>
</li>
<li><p class="first">Before accessing the QSPI Flash for the first time, the flash device must be enumerated:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sf probe
</pre></div>
</div>
</li>
<li><p class="first">Update the boot image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">bootimage_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">bootimage_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">bootimage_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootimage_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_bootimage_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootimage_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">bootimage_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_bootimage_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the boot script image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">bootscript_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootscript_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_bootscript_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootscript_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_bootscript_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the Linux kernel:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">kernel_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">kernel_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_kernel_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">kernel_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_kernel_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the devicetree image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">devicetree_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">devicetree_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_devicetree_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">devicetree_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_devicetree_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the rootfs image:</p>
<p>This step depends on the chosen boot device.</p>
<p>If QSPI RAMDISK was selected:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">ramdisk_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">ramdisk_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">ramdisk_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">ramdisk_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_ramdisk_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">ramdisk_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">ramdisk_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_ramdisk_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
<p>If QSPI was selected:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">jffs2_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">jffs2_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">jffs2_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">jffs2_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_rootfs_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">jffs2_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">jffs2_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_rootfs_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Zynq Ultrascale+ modules, QSPI boot mode with persistent rootfs is implemented using the SD card for the rootfs image. A .tar archive is generated for these modules instead of a .jffs2 file. This archive must be extracted to the Linux partition of the SD card. (For more information on how to prepare the boot medium, please refer to the official <a class="reference external" href="http://www.wiki.xilinx.com/Prepare+Boot+Medium">Xilinx guide</a>.)</p>
</div>
<ol class="arabic simple">
<li>Power off the board.</li>
<li>Configure the board to boot from the QSPI Flash (refer to the board User Manual).</li>
<li>Power on the board.</li>
<li>The board should boot the Linux system.</li>
</ol>
<p>If one wants to manually trigger booting from the QSPI Flash, the following command has to be invoked from the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run qspiboot
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that step 8 to 12 can be invoked independently.</p>
</div>
<div class="section" id="qspi-flash-using-the-full-image">
<span id="xilinx-qspi-flash-full"></span><h4>QSPI Flash using the full image<a class="headerlink" href="#qspi-flash-using-the-full-image" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Copy the <code class="docutils literal"><span class="pre">boot_full.bin</span></code> (or <code class="docutils literal"><span class="pre">boot_full_ramdisk.bin</span></code> when using RAMDISK, which must be renamed to <code class="docutils literal"><span class="pre">boot_full.bin</span></code>) file from the build environment output directory to the TFTP server directory.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal"><span class="pre">boot_full.bin</span></code> file is available only for modules equipped with Zynq-7000 devices.</p>
</div>
<ol class="arabic">
<li><p class="first">Flash the QSPI memory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">bootfull_loadaddr</span><span class="si">}</span> 0xFF 0x4000000
tftpboot <span class="si">${</span><span class="nv">bootfull_loadaddr</span><span class="si">}</span> boot_full.bin
sf probe
sf erase 0x0 0x4000000
sf write <span class="si">${</span><span class="nv">bootfull_loadaddr</span><span class="si">}</span> 0x0 <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the board to boot from the QSPI flash (refer to the board’s User Manual).</p>
</li>
<li><p class="first">Reset the board.</p>
</li>
<li><p class="first">The board should boot the Linux system.</p>
</li>
</ol>
<p>If you want to manually trigger booting from the QSPI flash, the following command has to be invoked from the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run qspiboot
</pre></div>
</div>
</div>
</div>
<div class="section" id="nand-flash">
<span id="xilinx-nand"></span><h3>NAND Flash<a class="headerlink" href="#nand-flash" title="Permalink to this headline">¶</a></h3>
<p>Enclustra Build Environment does not support direct boot from the NAND Flash memory.
The FSBL and the U-Boot have to be started from SD Card (MMC) or QSPI Flash.
Please refer to <a class="reference internal" href="#xilinx-mmc"><span class="std std-ref">SD Card (MMC)</span></a> or <a class="reference internal" href="#xilinx-qspi"><span class="std std-ref">eMMC Flash</span></a> in order to boot U-Boot from SD Card or QSPI Flash.
When U-Boot is booted it can load and boot the Linux system stored on the NAND Flash memory.</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout">
<caption><span class="caption-number">Table 4 </span><span class="caption-text">Xilinx Family NAND Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Linux kernel</th>
<td>0x0</td>
<td>0x500000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux Device Tree</th>
<td>0x500000</td>
<td>0x100000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>0x600000</td>
<td>0x100000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>0x700000</td>
<td>Rest of the NAND Storage space</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Not all Xilinx-based modules come with NAND Flash memory.</p>
</div>
<p>In order to deploy images and boot the Linux system from NAND Flash, do the following steps:</p>
<ol class="arabic">
<li><p class="first">Setup an TFTP server on the host computer.</p>
</li>
<li><p class="first">Power on the board and boot to U-Boot (e.g. from a SD Card (MMC)).</p>
</li>
<li><p class="first">Connect an Ethernet cable to the device.</p>
</li>
<li><p class="first">Connect a serial console to the device (e.g. using PuTTY or picocom).</p>
</li>
<li><p class="first">Copy the kernel image (<code class="docutils literal"><span class="pre">uImage</span></code> for Zynq-7000 or <code class="docutils literal"><span class="pre">Image</span></code> for Zynq Ultrascale+), <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">uboot.scr</span></code> and <code class="docutils literal"><span class="pre">rootfs.ubi</span></code>  files from the build environment output directory to the TFTP server directory.</p>
</li>
<li><p class="first">Stop the U-Boot autoboot.</p>
</li>
<li><p class="first">Setup the U-Boot connection parameters (in the U-Boot console):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>setenv ipaddr <span class="s1">&#39;xxx.xxx.xxx.xxx&#39;</span>
<span class="c1"># where xxx.xxx.xxx.xxx is the board address</span>
setenv serverip <span class="s1">&#39;yyy.yyy.yyy.yyy&#39;</span>
<span class="c1"># where yyy.yyy.yyy.yyy is the server (host computer) address</span>
</pre></div>
</div>
</li>
<li><p class="first">Set the memory pinmux to NAND Flash:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>zx_set_storage NAND
</pre></div>
</div>
</li>
<li><p class="first">Update the boot script image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">bootscript_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootscript_image</span><span class="si">}</span>
nand device <span class="m">0</span>
nand erase.part nand-bootscript
nand write <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> nand-bootscript <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the Linux kernel:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">kernel_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">kernel_image</span><span class="si">}</span>
nand device <span class="m">0</span>
nand erase.part nand-linux
nand write <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> nand-linux <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the devicetree image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">devicetree_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">devicetree_image</span><span class="si">}</span>
nand device <span class="m">0</span>
nand erase.part nand-device-tree
nand write <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> nand-device-tree <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the rootfs image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">ubifs_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">ubifs_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">ubifs_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">ubifs_image</span><span class="si">}</span>
nand device <span class="m">0</span>
nand erase.part nand-rootfs
nand write <span class="si">${</span><span class="nv">ubifs_loadaddr</span><span class="si">}</span> nand-rootfs <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Trigger NAND Flash boot with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run nandboot
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that step 8 to 11 can be invoked independently.</p>
</div>
</div>
<div class="section" id="usb-drive">
<h3>USB Drive<a class="headerlink" href="#usb-drive" title="Permalink to this headline">¶</a></h3>
<p>The Xilinx family devices cannot boot directly from a USB Drive.
The FSBL and the U-Boot have to be started from SD Card (MMC) or QSPI Flash.
Please refer to <a class="reference internal" href="#xilinx-mmc"><span class="std std-ref">SD Card (MMC)</span></a> or <a class="reference internal" href="#xilinx-qspi"><span class="std std-ref">eMMC Flash</span></a> in order to boot U-Boot from SD Card or QSPI Flash.
When U-Boot is booted it can load and boot the Linux system stored on the USB Drive.</p>
<p>In order to deploy images and boot the Linux system from a USB Drive, perform the following steps:</p>
<ol class="arabic">
<li><p class="first">Create a FAT formatted partition as the first partition on the drive. The size of the partition should be at least 64 MiB. (For more information on how to prepare the boot medium, please refer to the official <a class="reference external" href="http://www.wiki.xilinx.com/Prepare+Boot+Medium">Xilinx guide</a>.)</p>
</li>
<li><p class="first">Copy the kernel image (<code class="docutils literal"><span class="pre">uImage</span></code> for Zynq-7000 or <code class="docutils literal"><span class="pre">Image</span></code> for Zynq Ultrascale+), <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">uramdisk</span></code> and <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> (which must be renamed to <code class="docutils literal"><span class="pre">uboot.scr</span></code>) from the build environment output directory to the FAT formatted partition.</p>
</li>
<li><p class="first">Insert the USB drive into the USB port of the board.</p>
</li>
<li><p class="first">Configure the board to boot from the SD Card (MMC) or QSPI Flash (refer to the board User Manual).</p>
</li>
<li><p class="first">Power on the board and stop the U-Boot autoboot.</p>
</li>
<li><p class="first">Trigger USB boot with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run usbboot
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="nfs">
<h3>NFS<a class="headerlink" href="#nfs" title="Permalink to this headline">¶</a></h3>
<p>The Xilinx family devices cannot boot directly from NFS.</p>
<p>The FSBL and the U-Boot have to be started from SD Card (MMC), with the images generated by the build environment. When U-Boot is booted it can load and boot the Linux system from the host machine via Ethernet. Please refer to <a class="reference internal" href="#nfs-preparation-guide"><span class="std std-ref">NFS Preparation Guide</span></a> to prepare your system for NFS boot.</p>
<p>In order to deploy images and boot the Linux system over NFS, do the following steps as root:</p>
<ol class="arabic">
<li><p class="first">Create a FAT formatted BOOT partition as the first one on the SD Card. The size of the partition should be at least 64 MB. (For more information on how to prepare the boot medium, please refer to the official <a class="reference external" href="http://www.wiki.xilinx.com/Prepare+Boot+Medium">Xilinx guide</a>.)</p>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">boot.bin</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> from the build environment output directory onto the BOOT partition.</p>
</li>
<li><p class="first">Extract the <code class="docutils literal"><span class="pre">rootfs.tar</span></code> archive from the build environment output directory into the NFS folder.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo tar -xpf rootfs.tar -C /path/to/NFS
</pre></div>
</div>
</li>
<li><p class="first">Copy the kernel image (<code class="docutils literal"><span class="pre">uImage</span></code> for Zynq-7000 or <code class="docutils literal"><span class="pre">Image</span></code> for Zynq Ultrascale+), <code class="docutils literal"><span class="pre">devicetree.dtb</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> to the TFTP folder.</p>
</li>
<li><p class="first">Insert the card into the SD Card slot on the board.</p>
</li>
<li><p class="first">Configure the board to boot from the SD Card (MMC).</p>
</li>
<li><p class="first">Power on the board and stop the U-Boot autoboot.</p>
</li>
<li><p class="first">Set the server’s and target’s IP address, and the path to the rootfs NFS folder.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>env default -a
setenv ipaddr <span class="m">192</span>.168.1.10
setenv serverip <span class="m">192</span>.168.1.2
setenv serverpath /path/to/NFS
saveenv
</pre></div>
</div>
</li>
<li><p class="first">Trigger NFS boot with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run netboot
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Saving the U-Boot environment this way will ensure that NFS boot runs automatically after reboot.</p>
</div>
</div>
<div class="section" id="nfs-preparation-guide">
<span id="id5"></span><h3>NFS Preparation Guide<a class="headerlink" href="#nfs-preparation-guide" title="Permalink to this headline">¶</a></h3>
<p>For development, it can be very handy to mount the root filesystem via NFS (nfsroot).</p>
<p>To prepare the host machine several preparatory steps are required.</p>
<p>The following servers need to be installed on the host machine, and configured properly:</p>
<ul class="simple">
<li>NFS server (e.g. on Ubuntu <code class="docutils literal"><span class="pre">nfs-kernel-server</span></code>)</li>
<li>TFTP server (e.g. on Ubuntu <code class="docutils literal"><span class="pre">tftpd</span></code>)</li>
<li>DHCP server (e.g. on Ubuntu <code class="docutils literal"><span class="pre">isc-dhcp-server</span></code>)</li>
</ul>
<p>For demonstration purpose, the TFTP folder on the host is <code class="docutils literal"><span class="pre">/tftpboot</span></code>. It can be configured like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo mkdir /tftpboot
$ sudo chown nobody /tftpboot
$ nano /etc/xinetd.d/tftp
$ cat /etc/xinetd.d/tftp
service tftp
<span class="o">{</span>
<span class="nv">protocol</span> <span class="o">=</span> udp
<span class="nv">port</span> <span class="o">=</span> <span class="m">69</span>
<span class="nv">socket_type</span> <span class="o">=</span> dgram
<span class="nb">wait</span> <span class="o">=</span> yes
<span class="nv">user</span> <span class="o">=</span> nobody
<span class="nv">server</span> <span class="o">=</span> /usr/sbin/in.tftpd
<span class="nv">server_args</span> <span class="o">=</span> /tftpboot
<span class="nv">disable</span> <span class="o">=</span> no
<span class="o">}</span>
$ sudo /etc/init.d/xinetd restart
</pre></div>
</div>
<p>For demonstration purpose, the NFS export folder is <code class="docutils literal"><span class="pre">/nfs_exp</span></code>. In can be configured like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo mkdir /nfs_exp
$ sudo chown root:root /nfs_exp
$ sudo chmod <span class="m">777</span> /nfs_exp
$ sudo nano /etc/exports
$ cat /etc/exports
/nfs_exp <span class="m">192</span>.168.1.0/24<span class="o">(</span><span class="nv">fsid</span><span class="o">=</span><span class="m">0</span>,rw,no_subtree_check,no_root_squash<span class="o">)</span>
$ sudo exportfs -a
</pre></div>
</div>
<p>Sometimes it is also necessary to restart the NFS server:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo /etc/init.d/nfs-kernel-server restart
</pre></div>
</div>
<p>To configure the DHCP server do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat /etc/dhcp/dhcpd.conf
default-lease-time <span class="m">600</span><span class="p">;</span>
max-lease-time <span class="m">7200</span><span class="p">;</span>
option subnet-mask <span class="m">255</span>.255.255.0<span class="p">;</span>
option broadcast-address <span class="m">192</span>.168.1.255<span class="p">;</span>
option domain-name-servers <span class="m">192</span>.168.1.1, <span class="m">192</span>.168.1.2<span class="p">;</span>
subnet <span class="m">192</span>.168.1.0 netmask <span class="m">255</span>.255.255.0 <span class="o">{</span>
    range <span class="m">192</span>.168.1.10 <span class="m">192</span>.168.1.255<span class="p">;</span>
<span class="o">}</span>
$ sudo /etc/init.d/isc-dhcp-server restart
</pre></div>
</div>
<p>To select your ethernet interface edit <code class="docutils literal"><span class="pre">/etc/default/isc-dhcp-server</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo sed -i -r <span class="s1">&#39;s/INTERFACES=&quot;(.+)&quot;/INTERFACES=&quot;eth1&quot;/g&#39;</span> /etc/default/isc-dhcp-server
sudo /etc/init.d/isc-dhcp-server restart
</pre></div>
</div>
<p>On the target in the Linux console, the NFS folder from the host should now accessible like this</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># mkdir /nfs</span>
<span class="c1"># mount -t nfs -o port=2049,nolock,proto=tcp,ro,vers=3 &lt;server_ip&gt;:/nfs_exp /nfs</span>
<span class="c1"># cd /nfs</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that currently our Linux only supports NFS version 3, not 4. So the target folder needs to be specified, and the version is 3 (vers=3).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Take care to properly handle the permissions on the server. They should match those used on the client.</p>
</div>
<p>After configuring your system, you can now deploy the new boot images to your TFTP folder, and extract the rootfs TAR archive to your NFS folder.</p>
</div>
<div class="section" id="qspi-flash-layouts">
<span id="xilinx-qspi-layout"></span><h3>QSPI Flash Layouts<a class="headerlink" href="#qspi-flash-layouts" title="Permalink to this headline">¶</a></h3>
<p>The QSPI flash layout depends on the version of the Zynq chip that is present in the module.</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout-zynq-7010-7015-7020">
<caption><span class="caption-number">Table 5 </span><span class="caption-text">Xilinx Zynq-7010/7015/7020 Family QSPI Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout-zynq-7010-7015-7020" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Boot image</th>
<td>boot.bin</td>
<td>0x0</td>
<td>0x600000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>uImage</td>
<td>0x600000</td>
<td>0x500000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0xB00000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x3F80000</td>
<td>0x80000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot.scr/uboot_ramdisk.scr</td>
<td>0xB80000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>rootfs.jffs2/uramdisk</td>
<td>0xC00000</td>
<td>0x3380000</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout-zynq-7030">
<caption><span class="caption-number">Table 6 </span><span class="caption-text">Xilinx Zynq-7030 Family QSPI Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout-zynq-7030" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Boot image</th>
<td>boot.bin</td>
<td>0x0</td>
<td>0x700000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>uImage</td>
<td>0x700000</td>
<td>0x500000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0xC00000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x3F80000</td>
<td>0x80000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot.scr/uboot_ramdisk.scr</td>
<td>0xC80000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>rootfs.jffs2/uramdisk</td>
<td>0xD00000</td>
<td>0x3280000</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout-zynq-7035-7045">
<caption><span class="caption-number">Table 7 </span><span class="caption-text">Xilinx Zynq-7035/7045 Family QSPI Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout-zynq-7035-7045" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Boot image</th>
<td>boot.bin</td>
<td>0x0</td>
<td>0xE00000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>uImage</td>
<td>0xE00000</td>
<td>0x500000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0x1300000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x3F80000</td>
<td>0x80000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot.scr/uboot_ramdisk.scr</td>
<td>0x1380000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>rootfs.jffs2/uramdisk</td>
<td>0x1400000</td>
<td>0x2B80000</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout-zu2cg-zu2eg-zu3eg-zu5ev">
<caption><span class="caption-number">Table 8 </span><span class="caption-text">Xilinx Zynq Ultrascale+ ZU2CG/ZU2EG/ZU3EG/ZU5EV Family QSPI Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout-zu2cg-zu2eg-zu3eg-zu5ev" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Boot image</th>
<td>boot.bin</td>
<td>0x0</td>
<td>0x900000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>Image</td>
<td>0x900000</td>
<td>0xE00000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0x1700000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x3F80000</td>
<td>0x80000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot_ramdisk.scr</td>
<td>0x1780000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>uramdisk</td>
<td>0x1800000</td>
<td>0x2780000</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout-zu6eg-zu9eg">
<caption><span class="caption-number">Table 9 </span><span class="caption-text">Xilinx Zynq Ultrascale+ ZU6EG/ZU9EG Family QSPI Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout-zu6eg-zu9eg" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Boot image</th>
<td>boot.bin</td>
<td>0x0</td>
<td>0x1D00000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>Image</td>
<td>0x1D00000</td>
<td>0xE00000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0x2B00000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x3F80000</td>
<td>0x80000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot_ramdisk.scr</td>
<td>0x2B80000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>uramdisk</td>
<td>0x2C00000</td>
<td>0x1580000</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table border="1" class="docutils" id="xilinx-qspi-flash-layout-zu15eg">
<caption><span class="caption-number">Table 10 </span><span class="caption-text">Xilinx Zynq Ultrascale+ ZU15EG Family QSPI Flash Layout</span><a class="headerlink" href="#xilinx-qspi-flash-layout-zu15eg" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Boot image</th>
<td>boot.bin</td>
<td>0x0</td>
<td>0x1F00000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>Image</td>
<td>0x1F00000</td>
<td>0xE00000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0x2D00000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x3F80000</td>
<td>0x80000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot_ramdisk.scr</td>
<td>0x2D80000</td>
<td>0x80000</td>
</tr>
<tr class="row-odd"><th class="stub">Rootfs</th>
<td>uramdisk</td>
<td>0x2E00000</td>
<td>0x1580000</td>
</tr>
</tbody>
</table>
</div>
</div>
<span id="document-project_mode"></span><div class="section" id="project-mode">
<h2>Project mode<a class="headerlink" href="#project-mode" title="Permalink to this headline">¶</a></h2>
<p>For users who want to use the Enclustra Build Environment, but still be able to modify the parts of the system, a ‘project mode’ is available.</p>
<p>Project mode is similar to regular mode, but enables user to fully customize all the parts of the system.</p>
<p>To enable project mode, choose “Advanced” option on the very last screen of the GUI workflow.</p>
<blockquote>
<div><img alt="_images/project_name.png" src="_images/project_name.png" />
</div></blockquote>
<p>Check the ‘enable’ option on.</p>
<blockquote>
<div><img alt="_images/project_enable.png" src="_images/project_enable.png" />
</div></blockquote>
<p>Continue as usual.</p>
<p>After the regular build has finished, the sources of the components that were chosen to be fetched, are going to be copied to the output directory.
User is free to modify those sources and add a git upstream to them to keep them versioned.</p>
<p>Besides the sources, a new build script called build.sh is generated.
This script will run the Enclustra Build Environment in a special project mode.
In this mode the step for choosing components to fetch is skipped, and the user is prompted to choose which of the components to build.
If any of the components of the system were modified, the Build system will build them, and include the output files in the final boot images.</p>
</div>
<span id="document-update_binaries_xilinx"></span><div class="section" id="updating-the-binaries">
<h2>Updating the binaries<a class="headerlink" href="#updating-the-binaries" title="Permalink to this headline">¶</a></h2>
<p><strong>Changes in the FPGA design</strong></p>
<p>If you want to modify the FPGA design, you can update the binaries in two ways:</p>
<ol class="arabic">
<li><p class="first">By changing the path to custom binaries when you choose the device option in the Enclustra Build Environment.</p>
</li>
<li><p class="first">By using the project mode:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Enable project mode in the Enclustra Build Environment.</p>
</li>
<li><p class="first">Copy to the output directory (the directory with the boot sources created by the Enclustra Build Environment):</p>
<blockquote>
<div><ul class="simple">
<li>the new *.bit file (if you introduced changes to the FPGA programmable logic (PL)),</li>
<li>the new *.elf file (if you introduced changes to the processing system (PS) of the FPGA SoC).</li>
</ul>
</div></blockquote>
<p>Please note that the *.bit file should be named ‘fpga.bit’ and the *.elf file ‘fsbl.elf’.</p>
</li>
<li><p class="first">Run the Enclustra Build Environment.</p>
</li>
<li><p class="first">The new ‘boot.bin’ file will be generated in the output directory.
You can then place this file to boot the device (for example, in case of an SD Card, please refer to <a class="reference internal" href="index_xilinx.html#xilinx-mmc"><span class="std std-ref">SD Card (MMC)</span></a>).</p>
</li>
</ol>
</div></blockquote>
</li>
</ol>
<p><strong>Changes in U-boot, Linux or Buildroot</strong></p>
<p>If you want to modify U-boot, Linux or Buildroot, perform the following steps:</p>
<ol class="arabic">
<li><p class="first">Go to the ‘sources/’ directory, where U-boot, Linux and Buildroot repositories are placed.</p>
</li>
<li><p class="first">Introduce your changes in the selected repository.</p>
</li>
<li><p class="first">Run the Enclustra Build Environment in project mode to compile and build the modified sources.</p>
</li>
<li><p class="first">Replace the files on the target device, depending on which repository you changed:</p>
<blockquote>
<div><ul class="simple">
<li>xilinx-linux: the devicetree.dtb and the kernel image files (‘uImage’ for Zynq-7000 or ‘Image’ for Zynq Ultrascale+).</li>
<li>xilinx-uboot: the ‘uboot.scr’ and the ‘boot.bin’ file (containing the u-boot binary).</li>
<li>buildroot-rootfs: the ‘rootfs.tar’ archive (or the ‘rootfs.jffs2’ or ‘uramdisk’, depending on which the target device you choose).</li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<span id="document-faq_xilinx"></span><div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-to-script-u-boot">
<h3>How to script U-Boot?<a class="headerlink" href="#how-to-script-u-boot" title="Permalink to this headline">¶</a></h3>
<p>All U-Boot commands can be automated by scripting, so that it is much more convenient to deploy flash images to the hardware.</p>
<p>For example, QSPI deployment:</p>
<p>Put the following commands as plain text to a file <code class="docutils literal"><span class="pre">cmd.txt</span></code>:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>sf probe

echo &quot;boot image&quot;
mw.b ${bootimage_loadaddr} 0xFF ${bootimage_size}
tftpboot ${bootimage_loadaddr} ${bootimage_image}
sf erase ${qspi_bootimage_offset} ${bootimage_size}
sf write ${bootimage_loadaddr} ${qspi_bootimage_offset} ${filesize}

echo &quot;boot script&quot;
mw.b ${bootscript_loadaddr} 0xFF ${bootscript_size}
tftpboot ${bootscript_loadaddr} ${bootscript_image}
sf erase ${qspi_bootscript_offset} ${bootscript_size}
sf write ${bootscript_loadaddr} ${qspi_bootscript_offset} ${filesize}

echo &quot;Linux kernel&quot;
mw.b ${kernel_loadaddr} 0xFF ${kernel_size}
tftpboot ${kernel_loadaddr} ${kernel_image}
sf erase ${qspi_kernel_offset} ${kernel_size}
sf write ${kernel_loadaddr} ${qspi_kernel_offset} ${filesize}

echo &quot;devicetree&quot;
mw.b ${devicetree_loadaddr} 0xFF ${devicetree_size}
tftpboot ${devicetree_loadaddr} ${devicetree_image}
sf erase ${qspi_devicetree_offset} ${devicetree_size}
sf write ${devicetree_loadaddr} ${qspi_devicetree_offset} ${filesize}

echo &quot;rootfs image&quot;
mw.b ${jffs2_loadaddr} 0xFF ${jffs2_size}
tftpboot ${jffs2_loadaddr} ${jffs2_image}
sf erase ${qspi_rootfs_offset} ${jffs2_size}
sf write ${jffs2_loadaddr} ${qspi_rootfs_offset} ${filesize}

run qspiboot
</pre></div>
</div>
<p>Then generate an image <code class="docutils literal"><span class="pre">cmd.img</span></code> and put it onto the TFTP server on the host computer like following. Note that on Windows operating systems this needs to be executed in SoC EDS Command Shell. Be sure to use Unix line endings.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mkimage -T script -C none -n <span class="s2">&quot;QSPI flash commands&quot;</span> -d cmd.txt cmd.img
cp cmd.img /tftpboot
</pre></div>
</div>
<p>And finally, load the file on the target platform in U-boot and execute it, like this (after step 5 Setup U-Boot connection parameters, in the user documentation):</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>tftpboot 100000 cmd.img
source 100000
</pre></div>
</div>
</div>
<div class="section" id="how-can-the-flash-memory-be-programmed-from-linux">
<h3>How can the flash memory be programmed from Linux?<a class="headerlink" href="#how-can-the-flash-memory-be-programmed-from-linux" title="Permalink to this headline">¶</a></h3>
<p>In order to program flash memory from Linux, a script like the following one can be used. - All required files need to be present in the current folder. They can be loaded via TFTP or from USB drive / SD card.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

getsize <span class="o">()</span>
<span class="o">{</span>
        <span class="nb">local</span>  <span class="nv">size</span><span class="o">=</span><span class="sb">`</span>ls -al <span class="nv">$1</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $5 }&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$size</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="nv">BOOTIMAGE_FILE</span><span class="o">=</span><span class="s2">&quot;boot.bin&quot;</span>
<span class="nv">KERNEL_FILE</span><span class="o">=</span><span class="s2">&quot;Image&quot;</span>
<span class="nv">DEVICETREE_FILE</span><span class="o">=</span><span class="s2">&quot;devicetree.dtb&quot;</span>
<span class="nv">SCRIPT_FILE</span><span class="o">=</span><span class="s2">&quot;uboot.scr&quot;</span>
<span class="nv">ROOTFS_FILE</span><span class="o">=</span><span class="s2">&quot;rootfs.jffs2&quot;</span>

<span class="c1"># write boot image</span>
flash_erase /dev/mtd0 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">BOOTIMAGE_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing preloader file <span class="si">${</span><span class="nv">BOOTIMAGE_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="m">0</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">BOOTIMAGE_FILE</span><span class="si">}</span>

<span class="c1"># write Linux kernel</span>
flash_erase /dev/mtd1 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">KERNEL_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing kernel file <span class="si">${</span><span class="nv">KERNEL_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd1 <span class="m">0</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">KERNEL_FILE</span><span class="si">}</span>

<span class="c1"># write devicetree</span>
flash_erase /dev/mtd2 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">DEVICETREE_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing devicetree <span class="si">${</span><span class="nv">DEVICETREE_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd2 <span class="m">0</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">DEVICETREE_FILE</span><span class="si">}</span>

<span class="c1"># delete U-Boot configuration</span>
flash_erase /dev/mtd3 <span class="m">0</span> <span class="m">0</span>

<span class="c1"># write boot script</span>
flash_erase /dev/mtd4 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">SCRIPT_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing bootscript file <span class="si">${</span><span class="nv">SCRIPT_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd4 <span class="m">0</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">SCRIPT_FILE</span><span class="si">}</span>

<span class="c1"># write rootfs</span>
flash_erase /dev/mtd5 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">ROOTFS_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing rootfs file <span class="si">${</span><span class="nv">ROOTFS_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd5 <span class="m">0</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">ROOTFS_FILE</span><span class="si">}</span>
</pre></div>
</div>
<p>Just make the script executable and execute it like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>chmod +x flash.sh
./flash.sh
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please refer to the user documentation of the developer tools for more information.</p>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index_xilinx.html#document-index_xilinx">
              <img class="logo" src="_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index_xilinx.html#document-index_xilinx">Table Of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-introduction">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#version-information">Version Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-system">Build Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#repositories-structure">Repositories Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#general-build-environment-configuration">General Build Environment Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-supported_devices_xilinx">Supported Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-quickstart_xilinx">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#gui">GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#command-line">Command Line</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#deployment">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#sd-card-mmc">SD Card (MMC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#emmc-flash">eMMC Flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#qspi-flash">QSPI Flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#nand-flash">NAND Flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#usb-drive">USB Drive</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#nfs">NFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#nfs-preparation-guide">NFS Preparation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#qspi-flash-layouts">QSPI Flash Layouts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-project_mode">Project mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-update_binaries_xilinx">Updating the binaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_xilinx.html#document-faq_xilinx">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#how-to-script-u-boot">How to script U-Boot?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_xilinx.html#how-can-the-flash-memory-be-programmed-from-linux">How can the flash memory be programmed from Linux?</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index_xilinx.html#document-index_xilinx">Enclustra Build Environment - User Documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright Antmicro Ltd for Enclustra GmbH, 2015.
      Last updated on 2018-11-22.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.
    </div>
  </body>
</html>