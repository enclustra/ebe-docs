
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Enclustra Build Environment - User Documentation</title>
    <link rel="stylesheet" href="_static/rtd.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index_altera.html#document-index_altera">Enclustra Build Environment - User Documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="project">
<h1>Enclustra Build Environment - User Documentation<a class="headerlink" href="#project" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
<span id="document-introduction"></span><div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This is the user documentation for the Enclustra Build Environment project.</p>
<div class="section" id="version-information">
<h3>Version Information<a class="headerlink" href="#version-information" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Date</th>
<th class="head">Rev</th>
<th class="head">Author</th>
<th class="head">Changes</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>2015-05-08</td>
<td>0.1.0</td>
<td>Karol Gugala</td>
<td>Buildsystem description</td>
</tr>
<tr class="row-odd"><td>2015-05-11</td>
<td>0.1.1</td>
<td>Aleksandra Szawara</td>
<td>Language check</td>
</tr>
<tr class="row-even"><td>2015-07-06</td>
<td>0.1.2</td>
<td>Aurelio Lucchesi</td>
<td>Minor corrections</td>
</tr>
<tr class="row-odd"><td>2015-11-20</td>
<td>0.1.3</td>
<td>Tomasz Gorochowik</td>
<td>Major reorganization</td>
</tr>
<tr class="row-even"><td>2016-06-21</td>
<td>0.1.4</td>
<td>Tomasz Gorochowik</td>
<td>Project mode section</td>
</tr>
<tr class="row-odd"><td>2017-06-23</td>
<td>0.1.5</td>
<td>Maciej Mikunda</td>
<td>Updates for release v1.5</td>
</tr>
<tr class="row-even"><td>2018-03-21</td>
<td>0.1.6</td>
<td>Mariusz Glebocki</td>
<td>Updates for release v1.6</td>
</tr>
</tbody>
</table>
</div>
</div>
<span id="document-system"></span><div class="section" id="build-environment">
<h2>Build Environment<a class="headerlink" href="#build-environment" title="Permalink to this headline">¶</a></h2>
<p>This chapter describes the usage of the build environment.
The whole build environment is written in <code class="docutils literal"><span class="pre">Python</span></code>.
Its internal functionality is determined by <cite>ini</cite> files placed in a specific directory layout.</p>
<div class="section" id="prerequisites">
<h3>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>To run the build script a Python interpreter is required.
The system is compatible with both, Python 2 and Python 3.</p>
<p>The build environment requires additional software to be installed as listed below:</p>
<table border="1" class="docutils" id="sample-table">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Required software</span><a class="headerlink" href="#sample-table" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">tool</th>
<th class="head">minimal version</th>
<th class="head">comments</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">dialog</th>
<td>1.2-20130928</td>
<td>Required only in the GUI mode</td>
</tr>
<tr class="row-odd"><th class="stub">make</th>
<td>3.81.8</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">git</th>
<td>1.9.1</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">mercurial</th>
<td>2.8.2</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">tar</th>
<td>1.27.1</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">unzip</th>
<td>6.0</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">curl</th>
<td>7.35.0</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">wget</th>
<td>1.15</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">bc</th>
<td>1.06.95</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">libssl-dev</th>
<td>1.0.0</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">patch</th>
<td>2.7.1</td>
<td>&#160;</td>
</tr>
<tr class="row-odd"><th class="stub">rsync</th>
<td>3.1.0</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><th class="stub">autoconf</th>
<td>2.69</td>
<td>Required to build a buildroot rootfs</td>
</tr>
<tr class="row-odd"><th class="stub">g++</th>
<td>4.8.3</td>
<td>Required to build a buildroot rootfs</td>
</tr>
<tr class="row-even"><th class="stub">gcc</th>
<td>4.8.3</td>
<td>Required to build the Linux kernel, U-Boot and a buildroot rootfs</td>
</tr>
</tbody>
</table>
<p>For more information on how to install the required packages in the supported systems, please refer to the corresponding subsection (<a class="reference internal" href="#suse"><span class="std std-ref">OpenSUSE 42.3</span></a>, <a class="reference internal" href="#ubuntu"><span class="std std-ref">Ubuntu 14.04 LTS</span></a>).</p>
<div class="section" id="opensuse-42-3">
<span id="suse"></span><h4>OpenSUSE 42.3<a class="headerlink" href="#opensuse-42-3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span></span>su -
zypper -n install -yt pattern devel_basis
zypper -n install -y autoconf bc curl gcc-c++ git glibc-32bit <span class="se">\</span>
                     mercurial python-dialog unzip wget
</pre></div>
</div>
</div>
<div class="section" id="ubuntu-14-04-lts">
<span id="ubuntu"></span><h4>Ubuntu 14.04 LTS<a class="headerlink" href="#ubuntu-14-04-lts" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo apt update
sudo apt install -y autoconf bc build-essential curl git mercurial <span class="se">\</span>
                    libc6-i386 python python-dialog unzip wget
</pre></div>
</div>
</div>
</div>
<div class="section" id="directory-structure">
<h3>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h3>
<p>The build environment is designed to work with a specific directory structure depicted below:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="p">|</span>-- bin
<span class="p">|</span>-- binaries
<span class="p">|</span>-- buildscripts
<span class="p">|</span>-- sources
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_1
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_2
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_3
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_4
<span class="p">|</span>-- targets
<span class="p">|</span>   <span class="p">|</span>-- Module_1
<span class="p">|</span>       <span class="p">|</span>-- BaseBoard_1
<span class="p">|</span>       <span class="p">|</span>-- BaseBoard_2
<span class="p">|</span>   <span class="p">|</span>-- Module_2
<span class="p">|</span>       <span class="p">|</span>-- BaseBoard_1
<span class="p">|</span>-- target_output
</pre></div>
</div>
<table border="1" class="docutils" id="folder-description">
<caption><span class="caption-number">Table 2 </span><span class="caption-text">Folder description</span><a class="headerlink" href="#folder-description" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Folder</th>
<th class="head">function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">bin</th>
<td>Remote toolchains installation folder.</td>
</tr>
<tr class="row-odd"><th class="stub">binaries</th>
<td>Additional target binaries download folder.</td>
</tr>
<tr class="row-even"><th class="stub">sources</th>
<td>master_git_repository clone folder. It contains submodule folders.</td>
</tr>
<tr class="row-odd"><th class="stub">buildscripts</th>
<td>Build system executable files.</td>
</tr>
<tr class="row-even"><th class="stub">targets</th>
<td>Target configurations are placed here.</td>
</tr>
<tr class="row-odd"><th class="stub">target_output</th>
<td>Folders generated during the build process, that contain the output files after a successful build of every specifc target.</td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>By default, the target output folders are named according to this folder naming scheme:</p>
<p><code class="docutils literal"><span class="pre">out_&lt;timestamp&gt;_&lt;module&gt;_&lt;board&gt;_&lt;bootmode&gt;</span></code>.</p>
<p class="last">The default name can be overwriten during the build process.</p>
</div>
</div>
<div class="section" id="repositories-structure">
<h3>Repositories Structure<a class="headerlink" href="#repositories-structure" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">sources</span></code> directory is the master git repository with a number of submodules pointing to actual code repositories.
During the fetch phase, the build environment synchronizes only the submodules required to build the selected targets.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>.
<span class="p">|</span>-- container_git_repository
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_1
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_2
<span class="p">|</span>   <span class="p">|</span>-- target_submodule_3
</pre></div>
</div>
</div>
<div class="section" id="general-build-environment-configuration">
<h3>General Build Environment Configuration<a class="headerlink" href="#general-build-environment-configuration" title="Permalink to this headline">¶</a></h3>
<p>Environment settings are stored in the <code class="docutils literal"><span class="pre">enclustra.ini</span></code> file in the main directory of the build environment.
Before starting the build script, one may need to adjust the general settings of the build environment by editing this file.
One of the most crucial setting is the number of build threads used in a parallel.
This parameter is set in the <code class="docutils literal"><span class="pre">[general]</span></code> section by changing the <code class="docutils literal"><span class="pre">nthreads</span></code> key.
Additionally, parameters in the <code class="docutils literal"><span class="pre">[debug]</span></code> section allow the user to adjust the logging settings:</p>
<ul class="simple">
<li>If the <code class="docutils literal"><span class="pre">debug-calls</span></code> option if set to <code class="docutils literal"><span class="pre">true</span></code>, the output of all external tool calls (such as <code class="docutils literal"><span class="pre">make</span></code>, <code class="docutils literal"><span class="pre">tar</span></code> etc.) will be displayed in the terminal.</li>
<li>If the <code class="docutils literal"><span class="pre">quiet-mode</span></code> option is set to <code class="docutils literal"><span class="pre">true</span></code>, the build log of the targets will not be printed to the terminal, only informations about actual build state will be shown. This option does not affect the <code class="docutils literal"><span class="pre">build-logfile</span></code> option.</li>
<li>If the <code class="docutils literal"><span class="pre">build-logfile</span></code> option is set to a file name, the build environment will write the whole build log output to that file. If the option is not set, the output will not be logged.</li>
<li>If the <code class="docutils literal"><span class="pre">break-on-error</span></code> option is set to <code class="docutils literal"><span class="pre">true</span></code>, the build environment will interrupted on the first error. Otherwise the build environment will only print an error message and continue to work on a next available target.</li>
</ul>
</div>
</div>
<span id="document-supported_devices_altera"></span><div class="section" id="supported-devices">
<h2>Supported Devices<a class="headerlink" href="#supported-devices" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils" id="supported-devices-altera">
<caption><span class="caption-number">Table 3 </span><span class="caption-text">Supported devices</span><a class="headerlink" href="#supported-devices-altera" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Family</th>
<th class="head">Module</th>
<th class="head">Base board</th>
<th class="head">Available targets</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Altera</th>
<td>Mars MA3</td>
<td>Mars EB1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Altera</th>
<td>Mars MA3</td>
<td>Mars PM3</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Altera</th>
<td>Mercury SA1</td>
<td>Mercury PE1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-odd"><th class="stub">Altera</th>
<td>Mercury+ SA2</td>
<td>Mercury PE1</td>
<td>Linux, U-Boot, Buildroot</td>
</tr>
<tr class="row-even"><th class="stub">Altera</th>
<td>Mercury+ AA1</td>
<td>Mercury PE1</td>
<td>Linux, Buildroot</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Mercury+ AA1, U-Boot is delivered as a precompiled binary. It is generated using the Intel/Altera SoCEDS tool. The AA1 module support is added using custom patches.</p>
</div>
</div>
<span id="document-quickstart_altera"></span><div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="gui">
<h3>GUI<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>By default the build script will fetch and build the latest EBE release.
To use a specific release you need to clone a clean copy of the EBE repo and switch to a selected release:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">enclustra</span><span class="o">-</span><span class="n">bsp</span><span class="o">/</span><span class="n">bsp</span><span class="o">-</span><span class="n">altera</span><span class="o">.</span><span class="n">git</span> <span class="o">-</span><span class="n">b</span> <span class="n">v1</span><span class="o">.</span><span class="n">x</span>
<span class="c1"># where v1.x is the release number (e.g. v1.5)</span>
</pre></div>
</div>
<p>In order to use the latest code, switch to develop release:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">enclustra</span><span class="o">-</span><span class="n">bsp</span><span class="o">/</span><span class="n">bsp</span><span class="o">-</span><span class="n">altera</span><span class="o">.</span><span class="n">git</span> <span class="o">-</span><span class="n">b</span> <span class="n">develop</span>
<span class="n">export</span> <span class="n">EBE_RELEASE</span><span class="o">=</span><span class="n">master</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Since software in the develop release uses code which is currently under development the resulting software may be unstable.</p>
</div>
<p>In order to build the software for a chosen board using the GUI, please follow these steps:</p>
<ol class="arabic simple">
<li>Clone the build environment repository with:</li>
</ol>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>git clone https://github.com/enclustra-bsp/bsp-altera.git
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Change to the bsp-altera directory:</li>
</ol>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">cd</span> bsp-altera
</pre></div>
</div>
</div></blockquote>
<ol class="arabic" start="3">
<li><p class="first">Run <code class="docutils literal"><span class="pre">./build.sh</span></code> script.</p>
</li>
<li><p class="first">The welcome screen provides basic information about the version of the build environment.</p>
<blockquote>
<div><img alt="_images/welcome_screen.png" src="_images/welcome_screen.png" />
</div></blockquote>
</li>
<li><p class="first">Choose the configuration.</p>
<blockquote>
<div><img alt="_images/choose_config_altera.png" src="_images/choose_config_altera.png" />
</div></blockquote>
</li>
<li><p class="first">Choose the module type.</p>
<blockquote>
<div><img alt="_images/module_altera.png" src="_images/module_altera.png" />
</div></blockquote>
</li>
<li><p class="first">Choose the base board type.</p>
<blockquote>
<div><img alt="_images/board_altera.png" src="_images/board_altera.png" />
</div></blockquote>
</li>
<li><p class="first">Choose the boot device.</p>
<blockquote>
<div><img alt="_images/bootmode.png" src="_images/bootmode.png" />
</div></blockquote>
</li>
<li><p class="first">Choose which targets available for the chosen device family will be fetched. On the bottom of the screen a short description of the highlighted target is displayed. Choosing certain targets may disable fetching others.</p>
<blockquote>
<div><img alt="_images/fetch.png" src="_images/fetch.png" />
</div></blockquote>
</li>
<li><p class="first">Choose which targets will be built. On the bottom of the screen a short description of a highlighted target is displayed. Choosing certain targets may disable building others. In order to use the default target configuration enable the <code class="docutils literal"><span class="pre">Load</span> <span class="pre">initial</span> <span class="pre">...</span> <span class="pre">configuration</span></code> checkbox. If changes have been made to the target, disable this checkbox, so that the changes are not overwritten during the build process.</p>
<blockquote>
<div><img alt="_images/build.png" src="_images/build.png" />
</div></blockquote>
</li>
<li><p class="first">Choose the exact version of the device (chip type, industrial/commercial grade, speed grade).</p>
<blockquote>
<div><img alt="_images/dev_option_altera.png" src="_images/dev_option_altera.png" />
</div></blockquote>
</li>
<li><p class="first">Customize binaries or use the default ones.</p>
<blockquote>
<div><img alt="_images/custom_bin_altera.png" src="_images/custom_bin_altera.png" />
</div></blockquote>
</li>
<li><p class="first">Verify all the chosen build parameters.</p>
<blockquote>
<div><img alt="_images/summary_altera.png" src="_images/summary_altera.png" />
</div></blockquote>
</li>
<li><p class="first">Choose whether or not to save the configuration for later use.</p>
<blockquote>
<div><img alt="_images/save_altera.png" src="_images/save_altera.png" />
</div></blockquote>
</li>
<li><p class="first">The build environment will fetch and build the chosen targets.</p>
</li>
</ol>
</div>
<div class="section" id="command-line">
<h3>Command Line<a class="headerlink" href="#command-line" title="Permalink to this headline">¶</a></h3>
<p>The build process can be invoked from the command line. All options that are available in the GUI are present on the command line interface as well.
A list of the available command line options can be obtained like this:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>./build.sh --help

usage: tool [-h] [--release ver] [-L] [--list-devices-raw] [-d device] [-l]
    [--list-targets-raw] [-x target] [-f target] [-b target]
    [--custom-build target steps] [--fetch-history target]
    [--list-dev-options] [--list-dev-binaries] [-B file path]
    [--anti-unicorn] [--expert-mode] [-o index] [--generate-project]
    [--build-project project_file] [--build-project-auto project_file]
    [-s cfg] [-c] [-C] [-v]

Enclustra Build Environment

optional arguments:
  -h, --help                    show this help message and exit
  --release ver                 specify release version of the buidscripts
  -L, --list-devices            list all available devices
  --list-devices-raw            list all available devices in a script
                                friendly way
  -d device, --device device    specify device as follows:
                                &lt;family&gt;/&lt;module&gt;/&lt;base_board&gt;/&lt;boot_device&gt;
  -l, --list-targets            list all targets for chosen device
  --list-targets-raw            list all targets for chosen device in a script
                                friendly way
  -x target                     fetch and build specific target
  -f target, --fetch target     fetch specific target
  -b target, --build target     build specific target
  --custom-build target steps   build specific target with specific steps
                                (comma separated)
  --fetch-history target        fetch specific target with history
  --list-dev-options            list all available device options for chosen
                                device
  --list-dev-binaries           list all available binary files for chosen
                                device
  -B file path, --custom-binary file path
                                exchange selected binary file with the one
                                pointed by the path
  --anti-unicorn                disables colored output
  --expert-mode                 expert mode: prepare the environment for
                                building the whole system manually
  -o index, --dev-option index  set device option by index, the default one
                                will be used if not specified
  --generate-project            generate project directory instead of a
                                regular output
  --build-project project_file  build project
  --build-project-auto project_file
                                build project automatically, skip the gui
  -s cfg, --saved-config cfg    use previously saved configuration file
  -c, --clean-all               delete all downloaded code, binaries, tools
                                and built files
  -C, --clean-soft              run clean commands for all specified targets
                                (if available)
  -v, --version                 print version
</pre></div>
</div>
<p>In order to list all available devices use the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -L
</pre></div>
</div>
<p>If the <code class="docutils literal"><span class="pre">build.sh</span></code> script is invoked with the <code class="docutils literal"><span class="pre">-d</span></code> option, the build environment switches to console mode.
This mode requires a valid device specifier in order to locate the device configuration within the <code class="docutils literal"><span class="pre">targets</span></code> directory for the specific device, e.g. for the <cite>Mercury SA1</cite> module on the <cite>Mercury PE1</cite> base board in <cite>QSPI</cite> boot mode, the command would look like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Mercury_SA1/Mercury_PE1/QSPI
</pre></div>
</div>
<p>Such a command will fetch and build all the default targets for a selected device.
To list all the available targets for a selected device, the user needs to add the <code class="docutils literal"><span class="pre">-l</span></code> switch to the command, e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Mercury_SA1/Mercury_PE1/QSPI -l
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">-x</span></code> option will fetch and build only the selected target, e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Mercury_SA1/Mercury_PE1/QSPI -x Linux
</pre></div>
</div>
<p>That will fetch and build only the <code class="docutils literal"><span class="pre">Linux</span></code> target for the selected device.</p>
<p>To only fetch or build a specific target, the user can specify those targets with the <code class="docutils literal"><span class="pre">-f</span></code> (fetch) and <code class="docutils literal"><span class="pre">-b</span></code> (build) options. It is possible to choose multiple targets, e.g. like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Mercury_SA1/Mercury_PE1/QSPI -f Linux -b Buildroot -x U-Boot
</pre></div>
</div>
<p>This will fetch Linux, build Buildroot and fetch/build U-Boot.</p>
<p>The <code class="docutils literal"><span class="pre">--list-dev-options</span></code> option will list all the available device options for the chosen device. It can be used like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Mercury_SA1/Mercury_PE1/QSPI -x Linux --list-dev-options
</pre></div>
</div>
<p>This will print out an indexed list of device options.</p>
<p>The <code class="docutils literal"><span class="pre">-o</span></code> option allows the user to choose a device option for the selected device by providing the index of a specific device option, like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh -d Mercury_SA1/Mercury_PE1/QSPI -x Linux -o <span class="m">1</span>
</pre></div>
</div>
<p>If no device option is selected, the default one will be used.</p>
<p>To reset the build environment and delete all downloaded code, binaries, tools and built files, the <code class="docutils literal"><span class="pre">--clean</span></code> option can be used:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./build.sh --clean
</pre></div>
</div>
</div>
</div>
<div class="section" id="deployment">
<h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>This chapter describes how to prepare the hardware to boot from different boot media, using the binaries generated from the build environment.</p>
<p>All the guides in this section require the user to build the required files for the chosen device, with the build environment, as described in the previous section.
Once the files are built, they can be deployed to the hardware as described in the following sub sections.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Default target output directories are named according to the following directory naming scheme:</p>
<p class="last"><code class="docutils literal"><span class="pre">out_&lt;timestamp&gt;_&lt;module&gt;_&lt;board&gt;_&lt;bootmode&gt;</span></code>.</p>
</div>
<p>As a general note on U-Boot used in all the following guides: U-Boot is using variables from the default environment. Moreover, the boot scripts used by U-Boot also rely on those variables. If the environment was changed and saved earlier, U-Boot will always use these saved environment variables on a fresh boot, even after changing the U-Boot environment.</p>
<table border="1" class="docutils" id="u-boot-environment-location-and-size">
<caption><span class="caption-number">Table 4 </span><span class="caption-text">U-Boot environment location and size</span><a class="headerlink" href="#u-boot-environment-location-and-size" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Altera chip</th>
<th class="head">Boot storage</th>
<th class="head">Environment storage</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Arria 10</th>
<td>MMC/eMMC</td>
<td>MMC/eMMC</td>
<td>0x200 (1 block)</td>
<td>0x1000 (8 blocks)</td>
</tr>
<tr class="row-odd"><th class="stub">Arria 10</th>
<td>QSPI</td>
<td>QSPI</td>
<td>0xD00000</td>
<td>0x1000</td>
</tr>
<tr class="row-even"><th class="stub">Cyclone V</th>
<td>All</td>
<td>QSPI</td>
<td>0x800000</td>
<td>0x40000</td>
</tr>
</tbody>
</table>
<p>To restore the default environment, run the following command in the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>env default -a
</pre></div>
</div>
<p>This will not overwrite the stored environment but will only restore the default one in the current run.
To permanently restore the default environment, the <code class="docutils literal"><span class="pre">saveenv</span></code> command has to be invoked.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A <code class="docutils literal"><span class="pre">***</span> <span class="pre">Warning</span> <span class="pre">-</span> <span class="pre">bad</span> <span class="pre">CRC,</span> <span class="pre">using</span> <span class="pre">default</span> <span class="pre">environment</span></code> warning message that appears when booting into U-Boot indicates that the default environment will be loaded.</p>
</div>
<div class="section" id="sd-card-mmc">
<span id="altera-mmc"></span><h3>SD Card (MMC)<a class="headerlink" href="#sd-card-mmc" title="Permalink to this headline">¶</a></h3>
<p>In order to deploy images to an SD Card and boot from it, perform the following steps as root:</p>
<ol class="arabic">
<li><p class="first">Prepare the SD Card (refer to the <a class="reference internal" href="#altera-partitioning"><span class="std std-ref">SD Card (MMC) Partitioning Guide</span></a>).</p>
</li>
<li><p class="first">Record the preloader/bootloader image to the unformatted partition of a SD Card (type a2):</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo dd <span class="k">if</span><span class="o">=</span>preloader-mkpimage.bin <span class="nv">of</span><span class="o">=</span>/dev/sdX2
sync
<span class="c1"># where X is the letter of the device</span>
</pre></div>
</div>
</li>
<li><p class="first">Mount the BOOT and rootfs partitions.</p>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">uImage</span></code>, <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">fpga.rbf</span></code>, <code class="docutils literal"><span class="pre">u-boot.img</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> (or <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> file when using RAMDISK, which must be renamed to <code class="docutils literal"><span class="pre">uboot.scr</span></code>) from the build environment output directory to the BOOT partition (FAT formatted). Copy <code class="docutils literal"><span class="pre">uramdisk</span></code> to the same partition (only when using RAMDISK).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">u-boot.img</span></code> is only required for Cyclone V modules.</p>
</div>
</li>
<li><p class="first">Extract the <code class="docutils literal"><span class="pre">rootfs.tar</span></code> archive from the build environment output directory onto the second partition (rootfs, ext2 formatted).</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo tar -xpf rootfs.tar -C /path/to/mmc/mountpoint
</pre></div>
</div>
</li>
<li><p class="first">Unmount all partitions mounted from the SD Card.</p>
</li>
<li><p class="first">Insert the card into the SD Card slot on the board.</p>
</li>
<li><p class="first">Configure the board to boot from the SD Card (refer to the board User Manual).</p>
</li>
<li><p class="first">Power on the board.</p>
</li>
<li><p class="first">The board should boot the Linux system.</p>
</li>
</ol>
<p>If one wants to manually trigger booting from a SD Card, the following command has to be invoked from the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run mmcboot
</pre></div>
</div>
</div>
<div class="section" id="emmc-flash">
<span id="altera-qspi"></span><h3>eMMC Flash<a class="headerlink" href="#emmc-flash" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section is valid only for the Mars MA3 and Mercury AA1 modules.</p>
</div>
</div></blockquote>
<p>On both Mars MA3 and Mercury AA1 module the MMC bus lines are shared between eMMC flash and SD card. It may be necessary to switch the pinmux between them during the flashing procedure. More information on memory pinmux switching can be found in section <a class="reference internal" href="#altera-pinmux-switching"><span class="std std-ref">Storage pinmux switching</span></a>.
In order to deploy images to eMMC flash and boot from it, perform the following steps:</p>
<ol class="arabic">
<li><p class="first">Setup a TFTP server on the host computer.</p>
</li>
<li><p class="first">Prepare the SD card as usual for <em>ramdisk</em> boot (refer to the <a class="reference internal" href="#altera-mmc"><span class="std std-ref">SD Card (MMC)</span></a> section)</p>
</li>
<li><p class="first">On the host machine, copy <code class="docutils literal"><span class="pre">uImage</span></code>, <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">uboot.scr</span></code> (or <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> file when using RAMDISK, which must be renamed to <code class="docutils literal"><span class="pre">uboot.scr</span></code>) , <code class="docutils literal"><span class="pre">rootfs.tar</span></code> (or <code class="docutils literal"><span class="pre">uramdisk</span></code> when using RAMDISK), <code class="docutils literal"><span class="pre">fpga.rbf</span></code>, <code class="docutils literal"><span class="pre">preloader-mkpimage.bin</span></code> and <code class="docutils literal"><span class="pre">u-boot.img</span></code> (only for the Mars MA3 module) from the EMMC build output directory to the TFTP server directory.</p>
</li>
<li><p class="first">Connect an Ethernet cable to the device.</p>
</li>
<li><p class="first">Connect a serial console to the device (e.g. using PuTTY or picocom).</p>
</li>
<li><p class="first">Power the board on and boot to U-Boot from an SD Card.</p>
</li>
<li><p class="first">Stop the U-Boot autoboot and manually boot to the Linux system:</p>
<p>This step depends on the chosen module.</p>
<p>For Mars MA3:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>setenv sd_target emmc
run mmcboot
</pre></div>
</div>
<p>For Mercury AA1:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>setenv linux_storage EMMC
setenv use_ramdisk <span class="m">1</span>
run bootcmd
</pre></div>
</div>
</li>
<li><p class="first">Format the eMMC card.</p>
<p>Run <code class="docutils literal"><span class="pre">fdisk</span></code> tool:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>fdisk /dev/mmcblk0
</pre></div>
</div>
<p>Within <code class="docutils literal"><span class="pre">fdisk</span></code> run the following commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># delete the partition table</span>
o
<span class="c1"># create a new partition</span>
n
<span class="c1"># choose primary</span>
p
<span class="c1"># set number to 2</span>
<span class="m">2</span>
<span class="c1"># leave default start sector</span>

<span class="c1"># set the size to 2 MiB</span>
+2M
<span class="c1"># change the partition type</span>
t
<span class="c1"># set type to Altera Boot Partition</span>
a2
<span class="c1"># create a new partition</span>
n
p
<span class="m">1</span>
<span class="c1"># leave default start sector</span>

<span class="c1"># set the size to 200 MiB</span>
+200M
<span class="c1"># set the 1st partition type to FAT32</span>
t
<span class="m">1</span>
c
<span class="c1"># create a new partition</span>
n
p
<span class="m">3</span>
<span class="c1"># leave default start and end sector</span>


<span class="c1"># set the 3rd partition type to Linux</span>
t
<span class="m">3</span>
<span class="m">83</span>
<span class="c1"># write changes and exit</span>
w
q
</pre></div>
</div>
<p>Format the 1st and 3rd partitions:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mkfs.fat -n BOOT /dev/mmcblk0p1
mkfs.ext2 -L rootfs /dev/mmcblk0p3
</pre></div>
</div>
</li>
<li><p class="first">Set the TFTP server IP address:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">TFTP_IP</span><span class="o">=</span><span class="s1">&#39;xxx.xxx.xxx.xxx&#39;</span>
<span class="c1"># where xxx.xxx.xxx.xxx is the TFTP server address</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the preloader/bootloader image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>tftp -g -r preloader-mkpimage.bin -l preloader-mkpimage.bin <span class="nv">$TFTP_IP</span>
dd <span class="k">if</span><span class="o">=</span>preloader-mkpimage.bin <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0p2
</pre></div>
</div>
</li>
<li><p class="first">Update the boot files:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mount /dev/mmcblk0p1 /mnt
tftp -g -r uImage -l /mnt/uImage <span class="nv">$TFTP_IP</span>
tftp -g -r devicetree.dtb -l /mnt/devicetree.dtb <span class="nv">$TFTP_IP</span>
tftp -g -r uboot.scr -l /mnt/uboot.scr <span class="nv">$TFTP_IP</span>
tftp -g -r fpga.rbf -l /mnt/fpga.rbf <span class="nv">$TFTP_IP</span>

<span class="c1"># only for Mars MA3:</span>
tftp -g -r u-boot.img -l /mnt/u-boot.img <span class="nv">$TFTP_IP</span>

<span class="c1"># when using RAMDISK rootfs:</span>
tftp -g -r uramdisk -l /mnt/uramdisk <span class="nv">$TFTP_IP</span>

sync <span class="o">&amp;&amp;</span> umount /mnt
</pre></div>
</div>
</li>
<li><p class="first">Update the rootfs:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step is required only when using persistent rootfs.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mount /dev/mmcblk0p3 /mnt
tftp -g -r rootfs.tar -l rootfs.tar <span class="nv">$TFTP_IP</span>
tar -xpf rootfs.tar -C /mnt
sync <span class="o">&amp;&amp;</span> umount /mnt
</pre></div>
</div>
</li>
<li><p class="first">Configure the board to boot from the eMMC flash (refer to the board User Manual).</p>
</li>
<li><p class="first">Reset the board.</p>
</li>
<li><p class="first">The board should boot the Linux system.</p>
</li>
</ol>
</div>
<div class="section" id="qspi-flash">
<h3>QSPI Flash<a class="headerlink" href="#qspi-flash" title="Permalink to this headline">¶</a></h3>
<p>The QSPI flash is divided into partitions based on the module’s family. The partition offsets are hard coded in the U-Boot code and should not be modified. For more detailed information on partition offsets and sizes, please refer to <a class="reference internal" href="#altera-qspi-layout"><span class="std std-ref">QSPI Flash Layouts</span></a>.</p>
<p>There are two ways of flashing the QSPI flash memory - deploy each system part step by step or use the generated QSPI flash image.
The first few steps are the same for both options. In order to prepare the flashing environment, perform the following steps:</p>
<ol class="arabic">
<li><p class="first">Setup an TFTP server on the host computer.</p>
</li>
<li><p class="first">Power on the board and boot to U-Boot (e.g. from a MMC card).</p>
</li>
<li><p class="first">Connect an Ethernet cable to the device.</p>
</li>
<li><p class="first">Connect a serial console to the device (e.g. using PuTTY or picocom).</p>
</li>
<li><p class="first">Setup the U-Boot connection parameters:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>setenv ipaddr <span class="s1">&#39;xxx.xxx.xxx.xxx&#39;</span>
<span class="c1"># where xxx.xxx.xxx.xxx is the board address</span>
setenv serverip <span class="s1">&#39;yyy.yyy.yyy.yyy&#39;</span>
<span class="c1"># where yyy.yyy.yyy.yyy is the server (host computer) address</span>
</pre></div>
</div>
</li>
</ol>
<p>Then, depending on the choice, follow the procedure described in the <a class="reference internal" href="#altera-qspi-flash-sbs"><span class="std std-ref">Flashing the QSPI step by step</span></a> or the <a class="reference internal" href="#altera-qspi-flash-full"><span class="std std-ref">Flashing the QSPI using the full image</span></a> subsection.</p>
<div class="section" id="flashing-the-qspi-step-by-step">
<span id="altera-qspi-flash-sbs"></span><h4>Flashing the QSPI step by step<a class="headerlink" href="#flashing-the-qspi-step-by-step" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Copy <code class="docutils literal"><span class="pre">uImage</span></code>, <code class="docutils literal"><span class="pre">devicetree.dtb</span></code>, <code class="docutils literal"><span class="pre">uboot.scr</span></code> (or <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> file when using RAMDISK, which must be renamed to <code class="docutils literal"><span class="pre">uboot.scr</span></code>) and <code class="docutils literal"><span class="pre">rootfs.jffs2</span></code> (or <code class="docutils literal"><span class="pre">uramdisk</span></code> when using RAMDISK), <code class="docutils literal"><span class="pre">u-boot.img</span></code> (only for the Cyclone V based modules), <code class="docutils literal"><span class="pre">fpga.rbf.img</span></code> and <code class="docutils literal"><span class="pre">preloader-mkpimage.bin</span></code> from the build environment output directory to the TFTP server directory.</p>
</li>
<li><p class="first">Set the memory pinmux to QSPI flash:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step is required only for the Arria 10 based modules.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>altera_set_storage QSPI
</pre></div>
</div>
</li>
<li><p class="first">Before accessing the QSPI Flash for the first time, the flash device must be enumerated:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sf probe
</pre></div>
</div>
</li>
<li><p class="first">Update the preloader/bootloader image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">preloader_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">preloader_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">preloader_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">preloader_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_preloader_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">preloader_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">preloader_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_preloader_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the U-Boot image:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step is required only for the Cyclone V based modules.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">uboot_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">qspi_uboot_erase_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">uboot_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">uboot_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_uboot_erase_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_uboot_erase_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">uboot_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_uboot_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the bitstream image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">bitstream_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">bitstream_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">bitstream_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">bitstream_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_bitstream_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">bitstream_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">bitstream_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_bitstream_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the boot script image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">bootscript_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootscript_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_bootscript_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">bootscript_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">bootscript_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_bootscript_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the Linux kernel:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">kernel_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">kernel_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_kernel_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">kernel_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">kernel_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_kernel_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the devicetree image:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">devicetree_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">devicetree_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_devicetree_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">devicetree_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">devicetree_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_devicetree_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the rootfs image:</p>
<p>This step depends on the chosen boot device.</p>
<p>If QSPI RAMDISK was selected:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">ramdisk_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">ramdisk_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">ramdisk_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">uramdisk_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_ramdisk_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">ramdisk_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">ramdisk_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_ramdisk_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
<p>If QSPI was selected:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">rootfs_loadaddr</span><span class="si">}</span> 0xFF <span class="si">${</span><span class="nv">rootfs_size</span><span class="si">}</span>
tftpboot <span class="si">${</span><span class="nv">rootfs_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">rootfs_image</span><span class="si">}</span>
sf erase <span class="si">${</span><span class="nv">qspi_rootfs_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">rootfs_size</span><span class="si">}</span>
sf write <span class="si">${</span><span class="nv">rootfs_loadaddr</span><span class="si">}</span> <span class="si">${</span><span class="nv">qspi_rootfs_offset</span><span class="si">}</span> <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the board to boot from the QSPI flash (refer to the board User Manual).</p>
</li>
<li><p class="first">Reset the board.</p>
</li>
<li><p class="first">The board should boot the Linux system.</p>
</li>
</ol>
<p>If you want to manually trigger booting from the QSPI flash, the following command has to be invoked from the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run qspiboot
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that the steps from 4 to 10 can be invoked independently.</p>
</div>
</div>
<div class="section" id="flashing-the-qspi-using-the-full-image">
<span id="altera-qspi-flash-full"></span><h4>Flashing the QSPI using the full image<a class="headerlink" href="#flashing-the-qspi-using-the-full-image" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Copy the <code class="docutils literal"><span class="pre">boot_full.bin</span></code> (or <code class="docutils literal"><span class="pre">boot_full_ramdisk.bin</span></code> when using RAMDISK, which must be renamed to <code class="docutils literal"><span class="pre">boot_full.bin</span></code>) file from the build environment output directory to the TFTP server directory.</p>
</li>
<li><p class="first">Set the memory pinmux to QSPI flash:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This step is required only for the Arria 10 based modules.</p>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span></span>altera_set_storage QSPI
</pre></div>
</div>
</li>
<li><p class="first">Flash the QSPI memory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mw.b <span class="si">${</span><span class="nv">preloader_loadaddr</span><span class="si">}</span> 0xFF 0x4000000
tftpboot <span class="si">${</span><span class="nv">preloader_loadaddr</span><span class="si">}</span> boot_full.bin
sf probe
sf erase 0x0 0x4000000
sf write <span class="si">${</span><span class="nv">preloader_loadaddr</span><span class="si">}</span> 0x0 <span class="si">${</span><span class="nv">filesize</span><span class="si">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the board to boot from the QSPI flash (refer to the board User Manual).</p>
</li>
<li><p class="first">Reset the board.</p>
</li>
<li><p class="first">The board should boot the Linux system.</p>
</li>
</ol>
<p>If you want to manually trigger booting from the QSPI flash, the following command has to be invoked from the U-Boot command line:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run qspiboot
</pre></div>
</div>
</div>
</div>
<div class="section" id="usb-drive">
<h3>USB Drive<a class="headerlink" href="#usb-drive" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">USB boot is supported only on Cyclone V modules.</p>
</div>
<p>The Altera family devices cannot boot directly from a USB device.
The preloader and the U-Boot have to be started from a SD Card (MMC) or QSPI flash.
Please refer to <a class="reference internal" href="#altera-mmc"><span class="std std-ref">SD Card (MMC)</span></a> or <a class="reference internal" href="#altera-qspi"><span class="std std-ref">eMMC Flash</span></a> to boot the U-Boot from MMC or QSPI.
When the U-Boot is booted it can load and boot the Linux system stored on the USB drive.</p>
<p>In order to deploy images and boot the Linux system from a USB drive, perform the following steps:</p>
<ol class="arabic">
<li><p class="first">Create a FAT formatted partition as the first partition on the drive. This partition should have at least 16 MiB.</p>
</li>
<li><p class="first">Create a ext2 formatted partition as the second partition on the drive. This partition should have at least 16 MiB.</p>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">uImage</span></code>, <code class="docutils literal"><span class="pre">devicetree.dtb</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> from the build environment output directory to the FAT formatted partition.</p>
</li>
<li><p class="first">Unpack root file system onto the ext2 partition of the USB drive. This has to be done as root.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo tar -xpf rootfs.tar -C /path/to/mmc/mountpoint
</pre></div>
</div>
</li>
<li><p class="first">Insert the USB drive into the USB port of the board.</p>
</li>
<li><p class="first">Configure the board to boot from the MMC card or QSPI flash (refer to the board User Manual).</p>
</li>
<li><p class="first">Power on the board.</p>
</li>
<li><p class="first">Stop the U-Boot autoboot.</p>
</li>
<li><p class="first">Trigger USB boot with</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run usbboot
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="nfs">
<h3>NFS<a class="headerlink" href="#nfs" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">NFS boot is supported only on Cyclone V modules.</p>
</div>
<p>The preloader and the U-Boot have to be started from a SD Card (MMC), with the images generated by the build environment. When U-Boot is booted it can load and boot the Linux system from the host machine via Ethernet. Please refer to <a class="reference internal" href="#nfs-preparation-guide"><span class="std std-ref">NFS Preparation Guide</span></a> to prepare your system for NFS boot.</p>
<p>In order to deploy images and boot the Linux system over NFS, perform the following steps as root:</p>
<ol class="arabic">
<li><p class="first">Prepare the SD Card (refer to the <a class="reference internal" href="#altera-partitioning"><span class="std std-ref">SD Card (MMC) Partitioning Guide</span></a>).</p>
</li>
<li><p class="first">Record the preloader image to the unformatted partition of a SD Card (type a2):</p>
<blockquote>
<div><div class="highlight-bash"><div class="highlight"><pre><span></span>sudo dd <span class="k">if</span><span class="o">=</span>preloader-mkpimage.bin <span class="nv">of</span><span class="o">=</span>/dev/sdX2
sync
<span class="c1"># where X is the letter of the device</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">fpga.rbf</span></code>, <code class="docutils literal"><span class="pre">u-boot.img</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> from the build environment output directory to the BOOT partition.</p>
</li>
<li><p class="first">Copy <code class="docutils literal"><span class="pre">uImage</span></code>, <code class="docutils literal"><span class="pre">devicetree.dtb</span></code> and <code class="docutils literal"><span class="pre">uboot.scr</span></code> from the build environment output directory to the TFTP folder.</p>
</li>
<li><p class="first">Extract the <code class="docutils literal"><span class="pre">rootfs.tar</span></code> archive from the build environment output directory into the NFS folder.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo tar -xpf rootfs.tar -C /path/to/NFS
</pre></div>
</div>
</li>
<li><p class="first">Insert the card into the SD Card slot on the board.</p>
</li>
<li><p class="first">Configure the board to boot from the SD Card (MMC).</p>
</li>
<li><p class="first">Power on the board and stop the U-Boot autoboot.</p>
</li>
<li><p class="first">Set the server’s and target’s IP address, and the path to the rootfs NFS folder.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>env default -a
setenv ipaddr <span class="m">192</span>.168.1.10
setenv serverip <span class="m">192</span>.168.1.2
setenv serverpath /path/to/NFS
saveenv
</pre></div>
</div>
</li>
<li><p class="first">Trigger NFS boot with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run netboot
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Saving the U-Boot environment like above ensures that NFS boot will work automatically after reboot.</p>
</div>
</div>
<div class="section" id="sd-card-mmc-partitioning-guide">
<span id="altera-partitioning"></span><h3>SD Card (MMC) Partitioning Guide<a class="headerlink" href="#sd-card-mmc-partitioning-guide" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Insert the SD Card into the card reader of the host computer.</p>
</li>
<li><p class="first">If the partitions were mounted - unmount them:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo umount /path/to/mountpoint
</pre></div>
</div>
</li>
<li><p class="first">Run <code class="docutils literal"><span class="pre">fdisk</span></code> tool:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo fdisk /dev/sdX
<span class="c1"># where X is the letter of the SD card</span>
</pre></div>
</div>
</li>
<li><p class="first">Within <code class="docutils literal"><span class="pre">fdisk</span></code> run the following commands:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># create a new partition table</span>
o
<span class="c1"># create a new primary partition</span>
n
<span class="c1"># choose primary</span>
p
<span class="c1"># set number to &#39;2&#39;</span>
<span class="m">2</span>
<span class="c1"># leave default start sector</span>

<span class="c1"># set the size to 2 MiB</span>
+2M
<span class="c1"># change the partition type</span>
t
<span class="c1"># choose the second partition (may be chosen automatically if only one exists)</span>
<span class="m">2</span>
<span class="c1"># set type to Altera Boot Partition</span>
a2
<span class="c1"># create a new primary partition</span>
n
<span class="c1"># set as primary</span>
p
<span class="c1"># set number to &#39;1&#39;</span>
<span class="m">1</span>
<span class="c1"># leave default start sector</span>

<span class="c1"># set the size to 200MiB</span>
+200M
<span class="c1"># change the partition type</span>
t
<span class="c1"># choose the first partition</span>
<span class="m">1</span>
<span class="c1"># set type to W95 FAT32 (LBA)</span>
c
<span class="c1"># create the third partition</span>
n
<span class="c1"># set as primary</span>
p
<span class="c1"># set number to &#39;3&#39;</span>
<span class="m">3</span>
<span class="c1"># leave default start sector</span>

<span class="c1"># leave default end sector</span>

<span class="c1"># write changes to the disk</span>
w
<span class="c1"># leave &#39;fdisk&#39; (might be happening automatically)</span>
q
</pre></div>
</div>
</li>
<li><p class="first">Format newly created partitions:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>sudo mkfs.fat -n BOOT /dev/sdX1
sudo mkfs.ext2 -L rootfs /dev/sdX3
<span class="c1"># where X is the letter of the SD card</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="nfs-preparation-guide">
<span id="id1"></span><h3>NFS Preparation Guide<a class="headerlink" href="#nfs-preparation-guide" title="Permalink to this headline">¶</a></h3>
<p>For development, it can be very handy to mount the root filesystem via NFS (nfsroot).</p>
<p>To prepare the host machine several preparatory steps are required.</p>
<p>The following servers need to be installed on the host machine, and configured properly:</p>
<ul class="simple">
<li>NFS server (e.g. on Ubuntu <code class="docutils literal"><span class="pre">nfs-kernel-server</span></code>)</li>
<li>TFTP server (e.g. on Ubuntu <code class="docutils literal"><span class="pre">tftpd</span></code>)</li>
<li>DHCP server (e.g. on Ubuntu <code class="docutils literal"><span class="pre">isc-dhcp-server</span></code>)</li>
</ul>
<p>For demonstration purpose, the TFTP folder on the host is <code class="docutils literal"><span class="pre">/tftpboot</span></code>. It can be configured like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo mkdir /tftpboot
$ sudo chown nobody /tftpboot
$ nano /etc/xinetd.d/tftp
$ cat /etc/xinetd.d/tftp
service tftp
<span class="o">{</span>
<span class="nv">protocol</span> <span class="o">=</span> udp
<span class="nv">port</span> <span class="o">=</span> <span class="m">69</span>
<span class="nv">socket_type</span> <span class="o">=</span> dgram
<span class="nb">wait</span> <span class="o">=</span> yes
<span class="nv">user</span> <span class="o">=</span> nobody
<span class="nv">server</span> <span class="o">=</span> /usr/sbin/in.tftpd
<span class="nv">server_args</span> <span class="o">=</span> /tftpboot
<span class="nv">disable</span> <span class="o">=</span> no
<span class="o">}</span>
$ sudo /etc/init.d/xinetd restart
</pre></div>
</div>
<p>For demonstration purpose, the NFS export folder is <code class="docutils literal"><span class="pre">/nfs_exp</span></code>. In can be configured like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo mkdir /nfs_exp
$ sudo chown root:root /nfs_exp
$ sudo chmod <span class="m">777</span> /nfs_exp
$ sudo nano /etc/exports
$ cat /etc/exports
/nfs_exp <span class="m">192</span>.168.1.0/24<span class="o">(</span><span class="nv">fsid</span><span class="o">=</span><span class="m">0</span>,rw,no_subtree_check,no_root_squash<span class="o">)</span>
$ sudo exportfs -a
</pre></div>
</div>
<p>Sometimes it is also necessary to restart the NFS server:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo /etc/init.d/nfs-kernel-server restart
</pre></div>
</div>
<p>To configure the DHCP server do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ cat /etc/dhcp/dhcpd.conf
default-lease-time <span class="m">600</span><span class="p">;</span>
max-lease-time <span class="m">7200</span><span class="p">;</span>
option subnet-mask <span class="m">255</span>.255.255.0<span class="p">;</span>
option broadcast-address <span class="m">192</span>.168.1.255<span class="p">;</span>
option domain-name-servers <span class="m">192</span>.168.1.1, <span class="m">192</span>.168.1.2<span class="p">;</span>
subnet <span class="m">192</span>.168.1.0 netmask <span class="m">255</span>.255.255.0 <span class="o">{</span>
    range <span class="m">192</span>.168.1.10 <span class="m">192</span>.168.1.255<span class="p">;</span>
<span class="o">}</span>
$ sudo /etc/init.d/isc-dhcp-server restart
</pre></div>
</div>
<p>To select your ethernet interface edit <code class="docutils literal"><span class="pre">/etc/default/isc-dhcp-server</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$ sudo sed -i -r <span class="s1">&#39;s/INTERFACES=&quot;(.+)&quot;/INTERFACES=&quot;eth1&quot;/g&#39;</span> /etc/default/isc-dhcp-server
sudo /etc/init.d/isc-dhcp-server restart
</pre></div>
</div>
<p>On the target in the Linux console, the NFS folder from the host should now accessible like this</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># mkdir /nfs</span>
<span class="c1"># mount -t nfs -o port=2049,nolock,proto=tcp,ro,vers=3 &lt;server_ip&gt;:/nfs_exp /nfs</span>
<span class="c1"># cd /nfs</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that currently our Linux only supports NFS version 3, not 4. So the target folder needs to be specified, and the version is 3 (vers=3).</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Take care to properly handle the permissions on the server. They should match those used on the client.</p>
</div>
<p>After configuring your system, you can now deploy the new boot images to your TFTP folder, and extract the rootfs TAR archive to your NFS folder.</p>
</div>
<div class="section" id="qspi-flash-layouts">
<span id="altera-qspi-layout"></span><h3>QSPI Flash Layouts<a class="headerlink" href="#qspi-flash-layouts" title="Permalink to this headline">¶</a></h3>
<p>The QSPI flash layout depends on the version of the Altera chip that is present in the module.</p>
<table border="1" class="docutils" id="altera-cyclone-qspi-flash-layout">
<caption><span class="caption-number">Table 5 </span><span class="caption-text">Altera Cyclone V Family QSPI Flash Layout</span><a class="headerlink" href="#altera-cyclone-qspi-flash-layout" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Preloader</th>
<td>preloader-mkpimage.bin</td>
<td>0x0</td>
<td>0x40000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot image</th>
<td>u-boot.img</td>
<td>0x60000</td>
<td>0x60000</td>
</tr>
<tr class="row-even"><th class="stub">FPGA Bitstream</th>
<td>fpga.rbf.img</td>
<td>0x100000</td>
<td>0x700000</td>
</tr>
<tr class="row-odd"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0x800000</td>
<td>0x40000</td>
</tr>
<tr class="row-even"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0x840000</td>
<td>0x40000</td>
</tr>
<tr class="row-odd"><th class="stub">Bootscript</th>
<td>uboot.scr/uboot_ramdisk.scr</td>
<td>0x880000</td>
<td>0x40000</td>
</tr>
<tr class="row-even"><th class="stub">Linux kernel</th>
<td>uImage</td>
<td>0x8C0000</td>
<td>0x740000</td>
</tr>
<tr class="row-odd"><th class="stub">JFFS2 Rootfs</th>
<td>rootfs.jffs2/uramdisk</td>
<td>0x1000000</td>
<td>0x3000000</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<table border="1" class="docutils" id="altera-arria-qspi-flash-layout">
<caption><span class="caption-number">Table 6 </span><span class="caption-text">Altera Arria 10 Family QSPI Flash Layout</span><a class="headerlink" href="#altera-arria-qspi-flash-layout" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="25%" />
<col width="25%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head stub">Partition</th>
<th class="head">Filename</th>
<th class="head">Offset</th>
<th class="head">Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><th class="stub">Bootloader/U-Boot image</th>
<td>preloader-mkpimage.bin</td>
<td>0x0</td>
<td>0x100000</td>
</tr>
<tr class="row-odd"><th class="stub">FPGA Bitstream</th>
<td>fpga.rbf.img</td>
<td>0x100000</td>
<td>0xc00000</td>
</tr>
<tr class="row-even"><th class="stub">U-Boot environment</th>
<td>&#160;</td>
<td>0xd00000</td>
<td>0x40000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux Device Tree</th>
<td>devicetree.dtb</td>
<td>0xd40000</td>
<td>0x40000</td>
</tr>
<tr class="row-even"><th class="stub">Bootscript</th>
<td>uboot.scr/uboot_ramdisk.scr</td>
<td>0xd80000</td>
<td>0x40000</td>
</tr>
<tr class="row-odd"><th class="stub">Linux kernel</th>
<td>uImage</td>
<td>0xdc0000</td>
<td>0x580000</td>
</tr>
<tr class="row-even"><th class="stub">JFFS2 Rootfs</th>
<td>rootfs.jffs2/uramdisk</td>
<td>0x1340000</td>
<td>0x2cc0000</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="storage-pinmux-switching">
<span id="altera-pinmux-switching"></span><h3>Storage pinmux switching<a class="headerlink" href="#storage-pinmux-switching" title="Permalink to this headline">¶</a></h3>
<p>Some of the modules have various storage interfaces sharing the same processor pins.
The default storage pinmux depends on the selected boot target.
To allow the user to manually switch between them, additional U-Boot commands have been implemented.
As the commands may differ between modules, more detailed information can be found in the subsections below.</p>
<div class="section" id="storage-pinmux-on-mercury-aa1">
<h4>Storage pinmux on Mercury AA1<a class="headerlink" href="#storage-pinmux-on-mercury-aa1" title="Permalink to this headline">¶</a></h4>
<p>The SD Card, eMMC and QSPI controllers share common pins and only one of them can be used at a time.
It’s possible to switch between them using the <code class="docutils literal"><span class="pre">altera_set_storage</span></code> U-Boot command with one of three parameters:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">MMC</span></code></li>
<li><code class="docutils literal"><span class="pre">EMMC</span></code></li>
<li><code class="docutils literal"><span class="pre">QSPI</span></code></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The storage change is temporary.
It will reset to boot storage after reboot.
Also, it does not change the storage available in Linux (see next section).</p>
</div>
<p>Examples:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Switch to SD card</span>
<span class="o">=</span>&gt; altera_set_storage <span class="nv">MMC</span>
<span class="o">=</span>&gt; mmc <span class="nv">rescan</span>
<span class="o">=</span>&gt; mmc info
Device: SOCFPGA DWMMC
Manufacturer ID: <span class="m">3</span>
OEM: <span class="m">5344</span>
Name: SL08G
Tran Speed: <span class="m">50000000</span>
Rd Block Len: <span class="m">512</span>
SD version <span class="m">3</span>.0
High Capacity: Yes
Capacity: <span class="m">7</span>.4 GiB
Bus Width: <span class="m">4</span>-bit

<span class="c1"># Switch to eMMC</span>
<span class="o">=</span>&gt; altera_set_storage <span class="nv">EMMC</span>
<span class="o">=</span>&gt; mmc <span class="nv">rescan</span>
<span class="o">=</span>&gt; mmc info
Device: SOCFPGA DWMMC
Manufacturer ID: <span class="m">70</span>
OEM: <span class="m">100</span>
Name: W5251
Tran Speed: <span class="m">52000000</span>
Rd Block Len: <span class="m">512</span>
MMC version <span class="m">5</span>.0
High Capacity: Yes
Capacity: <span class="m">14</span>.3 GiB
Bus Width: <span class="m">8</span>-bit

<span class="c1"># Switch to QSPI</span>
<span class="o">=</span>&gt; altera_set_storage <span class="nv">QSPI</span>
<span class="o">=</span>&gt; mmc rescan
dwmci_send_cmd: Timeout on data busy
dwmci_send_cmd: Timeout on data busy
dwmci_send_cmd: Timeout on data busy
dwmci_send_cmd: Timeout on data busy
Card did not respond to voltage <span class="k">select</span>!
<span class="o">=</span>&gt; sf probe
SF: Read data capture delay calibrated to <span class="m">6</span> <span class="o">(</span><span class="m">0</span> - <span class="m">12</span><span class="o">)</span>
SF: Detected S25FL512S_256K with page size <span class="m">512</span> Bytes, erase size <span class="m">256</span> KiB, total <span class="m">64</span> MiB
</pre></div>
</div>
<div class="section" id="selecting-storage-used-by-linux">
<h5>Selecting storage used by Linux<a class="headerlink" href="#selecting-storage-used-by-linux" title="Permalink to this headline">¶</a></h5>
<p>The storage selection when booting Linux is automated.
There are two Linux storage-related U-Boot’s environment variables:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">linux_storage</span></code> - decides which storage will be available in Linux. Possible values are the same as in the <code class="docutils literal"><span class="pre">altera_set_storage</span></code> command (<code class="docutils literal"><span class="pre">MMC</span></code>, <code class="docutils literal"><span class="pre">EMMC</span></code>, <code class="docutils literal"><span class="pre">QSPI</span></code>). By default boot storage is used.</li>
<li><code class="docutils literal"><span class="pre">use_ramdisk</span></code> - when set to <code class="docutils literal"><span class="pre">0</span></code>, Linux will boot with rootfs located in the storage chosen with <code class="docutils literal"><span class="pre">linux_storage</span></code>. When set to <code class="docutils literal"><span class="pre">1</span></code>, ramdisk located in the boot partition of the boot storage will be used. Default value depends on the <code class="docutils literal"><span class="pre">.scr</span></code> file used - it is <code class="docutils literal"><span class="pre">1</span></code> for <code class="docutils literal"><span class="pre">uboot_ramdisk.scr</span></code> and <code class="docutils literal"><span class="pre">0</span></code> for <code class="docutils literal"><span class="pre">uboot.scr</span></code>.</li>
</ul>
<p>Examples:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Boot storage is assumed to be SD card (MMC)</span>

<span class="o">=</span>&gt; setenv linux_storage <span class="nv">QSPI</span>
<span class="o">=</span>&gt; run bootcmd
FPGA BRIDGES: <span class="nb">enable</span>
Booting on SD card...
<span class="m">1478</span> bytes <span class="nb">read</span> in <span class="m">3</span> ms <span class="o">(</span><span class="m">480</span>.5 KiB/s<span class="o">)</span>
<span class="c1">## Executing script at 00100000</span>
<span class="m">4068096</span> bytes <span class="nb">read</span> in <span class="m">364</span> ms <span class="o">(</span><span class="m">10</span>.7 MiB/s<span class="o">)</span>
<span class="m">16185</span> bytes <span class="nb">read</span> in <span class="m">8</span> ms <span class="o">(</span><span class="m">1</span>.9 MiB/s<span class="o">)</span>
Switching storage to QSPI
Booting with rootfs
<span class="o">(</span>...Linux with QSPI rootfs boots...<span class="o">)</span>

<span class="o">=</span>&gt; setenv linux_storage <span class="nv">EMMC</span>
<span class="o">=</span>&gt; setenv use_ramdisk <span class="nv">1</span>
<span class="o">=</span>&gt; run bootcmd
FPGA BRIDGES: <span class="nb">enable</span>
Booting on SD card...
<span class="m">1478</span> bytes <span class="nb">read</span> in <span class="m">3</span> ms <span class="o">(</span><span class="m">480</span>.5 KiB/s<span class="o">)</span>
<span class="c1">## Executing script at 00100000</span>
<span class="m">4068096</span> bytes <span class="nb">read</span> in <span class="m">364</span> ms <span class="o">(</span><span class="m">10</span>.7 MiB/s<span class="o">)</span>
<span class="m">16185</span> bytes <span class="nb">read</span> in <span class="m">8</span> ms <span class="o">(</span><span class="m">1</span>.9 MiB/s<span class="o">)</span>
<span class="m">17657259</span> bytes <span class="nb">read</span> in <span class="m">1558</span> ms <span class="o">(</span><span class="m">10</span>.8 MiB/s<span class="o">)</span>
Switching storage to EMMC
Booting with ramdisk
<span class="o">(</span>...Linux with ramdisk from SD card and access to eMMC storage boots...<span class="o">)</span>
</pre></div>
</div>
</div>
<div class="section" id="saving-the-linux-storage-selection-emmc-and-sd-card">
<h5>Saving the Linux storage selection - eMMC and SD card<a class="headerlink" href="#saving-the-linux-storage-selection-emmc-and-sd-card" title="Permalink to this headline">¶</a></h5>
<p>The variables, when changed in U-Boot, are reset after reboot.
To make them permanent, create <code class="docutils literal"><span class="pre">uEnv.txt</span></code> file on the boot partition located on the boot storage and put the variables in it, e.g.:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="nv">linux_storage</span><span class="o">=</span>QSPI
<span class="nv">use_ramdisk</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<p>Keep in mind, the file will not be editable on Linux when you set a different storage than the boot one.
In this case you can set the variable in U-Boot manually to your boot storage, boot the system and change <code class="docutils literal"><span class="pre">uEnv.txt</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># Boot storage assumed to be SD card (MMC) and linux_storage set to EMMC</span>

<span class="o">=</span>&gt; setenv linux_storage <span class="nv">MMC</span>
<span class="o">=</span>&gt; run bootcmd

<span class="o">(</span>...Linux boots...<span class="o">)</span>

buildroot login: root
Password:
<span class="c1"># mkdir /boot</span>
<span class="c1"># mount /dev/mmcblk0p1 /boot</span>
<span class="c1"># nano /boot/uEnv.txt</span>
</pre></div>
</div>
</div>
<div class="section" id="saving-the-linux-storage-selection-qspi">
<h5>Saving the Linux storage selection - QSPI<a class="headerlink" href="#saving-the-linux-storage-selection-qspi" title="Permalink to this headline">¶</a></h5>
<p>When using the QSPI storage, you can save your choice in U-Boot using the <code class="docutils literal"><span class="pre">saveenv</span></code> command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="o">=</span>&gt; setenv linux_storage <span class="nv">MMC</span>
<span class="o">=</span>&gt; setenv use_ramdisk <span class="nv">1</span>
<span class="o">=</span>&gt; saveenv
</pre></div>
</div>
<p>When Linux is using QSPI storage and you used <code class="docutils literal"><span class="pre">saveenv</span></code> in U-Boot at least once before, you can use the <code class="docutils literal"><span class="pre">fw_setenv</span></code> command in Linux. This works the same way as in U-Boot:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="c1"># fw_setenv linux_storage MMC</span>
<span class="c1"># fw_setenv use_ramdisk 1</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="memory-pinmux-on-mars-ma3">
<h4>Memory pinmux on Mars MA3<a class="headerlink" href="#memory-pinmux-on-mars-ma3" title="Permalink to this headline">¶</a></h4>
<p>On Mars MA3 the eMMC flash and SD Card controllers have common bus lines.
Depending on the boot mode, one of them is enabled when the other is put into reset.
The eMMC flash interface can be enabled by calling:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run altera_enable_emmc
</pre></div>
</div>
<p>The SD Card interface can be enabled with the following command:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>run altera_enable_mmc
</pre></div>
</div>
<p>Additionally, a more complex <code class="docutils literal"><span class="pre">altera_mux_sd_memory</span></code> function has been added to the U-Boot environment.
It enables the SD interface based on the <code class="docutils literal"><span class="pre">sd_target</span></code> U-Boot environment variable (possible values are <code class="docutils literal"><span class="pre">mmc</span></code> and <code class="docutils literal"><span class="pre">emmc</span></code>) and sets proper bus width (4 bit for SD/MMC Card and 8 bit for eMMC flash) in the dwmmc node in the Linux devicetree.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As <code class="docutils literal"><span class="pre">altera_mux_sd_memory</span></code> modifies the Linux devicetree, it requires the devicetree to be loaded earlier.</p>
</div>
<p>E.g. to enable eMMC, call:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>setenv sd_target emmc
run altera_mux_sd_memory
</pre></div>
</div>
<p>For an example see: <a class="reference internal" href="#altera-qspi"><span class="std std-ref">eMMC Flash</span></a> (Note that <code class="docutils literal"><span class="pre">altera_mux_sd_memory</span></code> is called in boot script.)</p>
</div>
</div>
</div>
<span id="document-project_mode"></span><div class="section" id="project-mode">
<h2>Project mode<a class="headerlink" href="#project-mode" title="Permalink to this headline">¶</a></h2>
<p>For users who want to use the Enclustra Build Environment, but still be able to modify the parts of the system, a ‘project mode’ is available.</p>
<p>Project mode is similar to regular mode, but enables user to fully customize all the parts of the system.</p>
<p>To enable project mode, choose “Advanced” option on the very last screen of the GUI workflow.</p>
<blockquote>
<div><img alt="_images/project_name.png" src="_images/project_name.png" />
</div></blockquote>
<p>Check the ‘enable’ option on.</p>
<blockquote>
<div><img alt="_images/project_enable.png" src="_images/project_enable.png" />
</div></blockquote>
<p>Continue as usual.</p>
<p>After the regular build has finished, the sources of the components that were chosen to be fetched, are going to be copied to the output directory.
User is free to modify those sources and add a git upstream to them to keep them versioned.</p>
<p>Besides the sources, a new build script called build.sh is generated.
This script will run the Enclustra Build Environment in a special project mode.
In this mode the step for choosing components to fetch is skipped, and the user is prompted to choose which of the components to build.
If any of the components of the system were modified, the Build system will build them, and include the output files in the final boot images.</p>
</div>
<span id="document-update_binaries_altera"></span><div class="section" id="updating-the-binaries">
<h2>Updating the binaries<a class="headerlink" href="#updating-the-binaries" title="Permalink to this headline">¶</a></h2>
<p><strong>Changes in the FPGA design</strong></p>
<p>If you want to modify the FPGA design, you can update the binaries in two ways:</p>
<ol class="arabic">
<li><p class="first">By changing the path to custom binaries when you are choosing the device option in the Enclustra Build Environment.</p>
</li>
<li><p class="first">By copying to the target device:</p>
<blockquote>
<div><ul class="simple">
<li>the new *.rbf file (if you introduced changes to the FPGA logic),</li>
<li>the new *.bin file (if you introduced changes to the hard processing system (HPS) of the FPGA SoC, e.g. in the clock configuration).</li>
</ul>
</div></blockquote>
<p>Please note that the *.rbf file should be named ‘fpga.rbf’ and the *.bin file ‘preloader-mkpimage.bin’.
Pay attention to choosing the correct partition to replace the files if you use an SD Card (please refer to <a class="reference internal" href="index_altera.html#altera-mmc"><span class="std std-ref">SD Card (MMC)</span></a>).</p>
</li>
</ol>
<p><strong>Changes in U-boot, Linux or Buildroot</strong></p>
<p>If you want to modify U-boot, Linux or Buildroot, perform the following steps:</p>
<ol class="arabic">
<li><p class="first">Go to the ‘sources/’ directory, where U-boot, Linux and Buildroot repositories are placed.</p>
</li>
<li><p class="first">Introduce your changes in the selected repository</p>
</li>
<li><p class="first">Run the Enclustra Build Environment in the project mode to compile and build the modified sources.</p>
</li>
<li><p class="first">Replace the files on the target device, depending on which repository you changed:</p>
<blockquote>
<div><ul class="simple">
<li>altera-linux: the ‘devicetree.dtb’ and ‘uImage’ files.</li>
<li>altera-uboot: the ‘uboot.scr’ and ‘uboot.img’ files (only for Cyclone V modules).</li>
<li>buildroot-rootfs: the ‘rootfs.tar’ archive (or the ‘rootfs.jffs2’ or ‘uramdisk’, depending on which the target device you choose).</li>
</ul>
</div></blockquote>
</li>
</ol>
</div>
<span id="document-faq_altera"></span><div class="section" id="faq">
<h2>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h2>
<div class="section" id="how-to-script-u-boot">
<h3>How to script U-Boot?<a class="headerlink" href="#how-to-script-u-boot" title="Permalink to this headline">¶</a></h3>
<p>All U-Boot commands can be automated by scripting, so that it is much more convenient to deploy flash images to the hardware.</p>
<p>For example, QSPI deployment:</p>
<p>Put the following commands as plain text to a file <code class="docutils literal"><span class="pre">cmd.txt</span></code>:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>sf probe

echo &quot;preloader&quot;
mw.b ${preloader_loadaddr} 0xFF ${preloader_size}
tftpboot ${preloader_loadaddr} ${preloader_image}
sf erase ${qspi_preloader_offset} ${preloader_size}
sf write ${preloader_loadaddr} ${qspi_preloader_offset} ${filesize}

echo &quot;U-Boot&quot;
mw.b ${uboot_loadaddr} 0xFF ${qspi_uboot_erase_size}
tftpboot ${uboot_loadaddr} ${uboot_image}
sf erase ${qspi_uboot_erase_offset} ${qspi_uboot_erase_size}
sf write ${uboot_loadaddr} ${qspi_uboot_offset} ${filesize}

echo &quot;FPGA bitstream&quot;
mw.b ${bitstream_loadaddr} 0xFF ${bitstream_size}
tftpboot ${bitstream_loadaddr} ${bitstream_image}
sf erase ${qspi_bitstream_offset} ${bitstream_size}
sf write ${bitstream_loadaddr} ${qspi_bitstream_offset} ${filesize}

echo &quot;boot script&quot;
mw.b ${bootscript_loadaddr} 0xFF ${bootscript_size}
tftpboot ${bootscript_loadaddr} ${bootscript_image}
sf erase ${qspi_bootscript_offset} ${bootscript_size}
sf write ${bootscript_loadaddr} ${qspi_bootscript_offset} ${filesize}

echo &quot;Linux kernel&quot;
mw.b ${kernel_loadaddr} 0xFF ${kernel_size}
tftpboot ${kernel_loadaddr} ${kernel_image}
sf erase ${qspi_kernel_offset} ${kernel_size}
sf write ${kernel_loadaddr} ${qspi_kernel_offset} ${filesize}

echo &quot;devicetree&quot;
mw.b ${devicetree_loadaddr} 0xFF ${devicetree_size}
tftpboot ${devicetree_loadaddr} ${devicetree_image}
sf erase ${qspi_devicetree_offset} ${devicetree_size}
sf write ${devicetree_loadaddr} ${qspi_devicetree_offset} ${filesize}

echo &quot;rootfs image&quot;
mw.b ${rootfs_loadaddr} 0xFF ${rootfs_size}
tftpboot ${rootfs_loadaddr} ${rootfs_image}
sf erase ${qspi_rootfs_offset} ${rootfs_size}
sf write ${rootfs_loadaddr} ${qspi_rootfs_offset} ${filesize}

run qspiboot
</pre></div>
</div>
<p>Then generate an image <code class="docutils literal"><span class="pre">cmd.img</span></code> and put it onto the TFTP server on the host computer like following. Note that on Windows operating systems this needs to be executed in SoC EDS Command Shell. Be sure to use Unix line endings.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>mkimage -T script -C none -n <span class="s2">&quot;QSPI flash commands&quot;</span> -d cmd.txt cmd.img
cp cmd.img /tftpboot
</pre></div>
</div>
<p>And finally, load the file on the target platform in U-boot and execute it, like this (after step 5 Setup U-Boot connection parameters, in the user documentation):</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>tftpboot 100000 cmd.img
source 100000
</pre></div>
</div>
</div>
<div class="section" id="how-can-the-flash-memory-be-programmed-from-linux">
<h3>How can the flash memory be programmed from Linux?<a class="headerlink" href="#how-can-the-flash-memory-be-programmed-from-linux" title="Permalink to this headline">¶</a></h3>
<p>In order to program flash memory from Linux, a script like the following one can be used. - All required files need to be present in the current folder. They can be loaded via TFTP or from USB drive / SD card. Be sure to set the address offset for each file according to <a class="reference internal" href="index_altera.html#altera-qspi-layout"><span class="std std-ref">QSPI Flash Layouts</span></a>.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

getsize <span class="o">()</span>
<span class="o">{</span>
        <span class="nb">local</span>  <span class="nv">size</span><span class="o">=</span><span class="sb">`</span>ls -al <span class="nv">$1</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $5 }&#39;</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">&quot;</span><span class="nv">$size</span><span class="s2">&quot;</span>
<span class="o">}</span>

<span class="nv">PRELOADER_FILE</span><span class="o">=</span><span class="s2">&quot;preloader-mkpimage.bin&quot;</span>
<span class="nv">PRELOADER_OFFSET</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
<span class="nv">UBOOT_FILE</span><span class="o">=</span><span class="s2">&quot;u-boot.img&quot;</span>
<span class="nv">UBOOT_OFFSET</span><span class="o">=</span><span class="s2">&quot;0x60000&quot;</span>
<span class="nv">BITSTREAM_FILE</span><span class="o">=</span><span class="s2">&quot;fpga.rbf.img&quot;</span>
<span class="nv">BITSTREAM_OFFSET</span><span class="o">=</span><span class="s2">&quot;0x100000&quot;</span>
<span class="nv">DEVICETREE_FILE</span><span class="o">=</span><span class="s2">&quot;devicetree.dtb&quot;</span>
<span class="nv">DEVICETREE_OFFSET</span><span class="o">=</span><span class="s2">&quot;0x840000&quot;</span>
<span class="nv">SCRIPT_FILE</span><span class="o">=</span><span class="s2">&quot;uboot.scr&quot;</span>
<span class="nv">SCRIPT_OFFSET</span><span class="o">=</span><span class="s2">&quot;0x880000&quot;</span>
<span class="nv">KERNEL_FILE</span><span class="o">=</span><span class="s2">&quot;uImage&quot;</span>
<span class="nv">KERNEL_OFFSET</span><span class="o">=</span><span class="s2">&quot;0x8C0000&quot;</span>
<span class="nv">ROOTFS_FILE</span><span class="o">=</span><span class="s2">&quot;rootfs.jffs2&quot;</span>
<span class="nv">ROOTFS_OFFSET</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>

<span class="c1"># write preloader</span>
flash_erase /dev/mtd0 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">PRELOADER_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing preloader file <span class="si">${</span><span class="nv">PRELOADER_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="si">${</span><span class="nv">PRELOADER_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">PRELOADER_FILE</span><span class="si">}</span>

<span class="c1"># write U-Boot image</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">UBOOT_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing uboot file <span class="si">${</span><span class="nv">UBOOT_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="si">${</span><span class="nv">UBOOT_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">UBOOT_FILE</span><span class="si">}</span>

<span class="c1"># write FPGA bitstream</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">BITSTREAM_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing bitstream file <span class="si">${</span><span class="nv">BITSTREAM_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="si">${</span><span class="nv">BITSTREAM_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">BITSTREAM_FILE</span><span class="si">}</span>

<span class="c1"># write devicetree</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">DEVICETREE_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing devicetree <span class="si">${</span><span class="nv">DEVICETREE_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="si">${</span><span class="nv">DEVICETREE_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">DEVICETREE_FILE</span><span class="si">}</span>

<span class="c1"># write boot script</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">SCRIPT_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing bootscript file <span class="si">${</span><span class="nv">SCRIPT_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="si">${</span><span class="nv">SCRIPT_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">SCRIPT_FILE</span><span class="si">}</span>

<span class="c1"># write Linux kernel</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">KERNEL_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing kernel file <span class="si">${</span><span class="nv">KERNEL_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd0 <span class="si">${</span><span class="nv">KERNEL_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">KERNEL_FILE</span><span class="si">}</span>

<span class="c1"># write rootfs</span>
flash_erase /dev/mtd1 <span class="m">0</span> <span class="m">0</span>
<span class="nv">FILESIZE</span><span class="o">=</span><span class="sb">`</span>getsize <span class="si">${</span><span class="nv">ROOTFS_FILE</span><span class="si">}</span><span class="sb">`</span>
<span class="nb">echo</span> Writing rootfs file <span class="si">${</span><span class="nv">ROOTFS_FILE</span><span class="si">}</span> size <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span>
mtd_debug write /dev/mtd1 <span class="si">${</span><span class="nv">ROOTFS_OFFSET</span><span class="si">}</span> <span class="si">${</span><span class="nv">FILESIZE</span><span class="si">}</span> <span class="si">${</span><span class="nv">ROOTFS_FILE</span><span class="si">}</span>
</pre></div>
</div>
<p>Just make the script executable and execute it like this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>chmod +x flash.sh
./flash.sh
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Please refer to the user documentation of the developer tools for more information.</p>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index_altera.html#document-index_altera">
              <img class="logo" src="_static/logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="index_altera.html#document-index_altera">Table Of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-introduction">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#version-information">Version Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-system">Build Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#repositories-structure">Repositories Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#general-build-environment-configuration">General Build Environment Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-supported_devices_altera">Supported Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-quickstart_altera">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#gui">GUI</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#command-line">Command Line</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#deployment">Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#sd-card-mmc">SD Card (MMC)</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#emmc-flash">eMMC Flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#qspi-flash">QSPI Flash</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#usb-drive">USB Drive</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#nfs">NFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#sd-card-mmc-partitioning-guide">SD Card (MMC) Partitioning Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#nfs-preparation-guide">NFS Preparation Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#qspi-flash-layouts">QSPI Flash Layouts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#storage-pinmux-switching">Storage pinmux switching</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-project_mode">Project mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-update_binaries_altera">Updating the binaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="index_altera.html#document-faq_altera">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#how-to-script-u-boot">How to script U-Boot?</a></li>
<li class="toctree-l2"><a class="reference internal" href="index_altera.html#how-can-the-flash-memory-be-programmed-from-linux">How can the flash memory be programmed from Linux?</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index_altera.html#document-index_altera">Enclustra Build Environment - User Documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright Antmicro Ltd for Enclustra GmbH, 2015.
      Last updated on 2018-11-22.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.
    </div>
  </body>
</html>